<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®å¯æ¢¦å¤ªç©ºå¯¹æˆ˜</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            font-family: Arial, sans-serif;
        }
        #gameCanvas {
            border: 1px solid #333;
            max-width: 100%;
            max-height: 100%;
        }
        .game-over {
            position: absolute;
            color: white;
            text-align: center;
            display: none;
        }
        .game-over h1 {
            color: red;
            font-size: 30px;
        }
        .game-over p {
            font-size: 20px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <div class="game-over" id="gameOverScreen">
        <h1>æ¸¸æˆç»“æŸ</h1>
        <p id="finalScore">æœ€ç»ˆåˆ†æ•°: 0</p>
        <p>æŒ‰ä»»æ„é”®æˆ–ç‚¹å‡»å±å¹•é‡æ–°å¼€å§‹</p>
    </div>

    <script>
        // æ¸¸æˆä¸»ç±»
        class PokemonSpaceGame {
            constructor() {
                // è·å–ç”»å¸ƒå’Œä¸Šä¸‹æ–‡
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gameOverScreen = document.getElementById('gameOverScreen');
                this.finalScoreText = document.getElementById('finalScore');
                
                // æ¸¸æˆçŠ¶æ€
                this.gameActive = true;
                this.gamePaused = false;
                this.waitForRestart = false;
                this.score = 0;
                this.lives = 3;
                this.level = 1;
                this.nextLevelScore = 20;
                
                // ç©å®¶ç›¸å…³å‚æ•°
                this.playerSize = 80;
                this.playerPos = {x: 160, y: 450};
                this.bullets = [];
                this.bulletSpeed = 12;
                
                // æ•Œäººç›¸å…³å‚æ•°
                this.enemies = [];
                this.enemySize = 50;
                this.enemySpeed = 2;
                this.spawnRate = 0.03;
                this.enemyFireRate = 0.01;
                this.enemyBullets = [];
                this.enemyBulletSpeed = 4;
                this.enemyBulletSize = 8;
                
                // åŠ è½½å›¾åƒ
                this.loadImages();
                
                // åŠ è½½éŸ³æ•ˆ
                this.loadSounds();
                
                // è®¾ç½®é”®ç›˜äº‹ä»¶ç›‘å¬
                this.setupKeyboardControls();
                
                // è®¾ç½®è§¦æ‘¸æ§åˆ¶
                this.setupTouchControls();
                
                // å¼€å§‹æ¸¸æˆå¾ªç¯
                this.lastTime = 0;
                this.init();
            }
            
            loadImages() {
                // èƒŒæ™¯å›¾åƒ
                this.bgImage = new Image();
                this.bgImage.src = '/images/earth_view.jpg';
                this.bgImage.onload = () => this.bgLoaded = true;
                
                // ç©å®¶å›¾åƒ
                this.playerImage = new Image();
                this.playerImage.src = '/images/rayquaza.png';
                this.playerImage.onload = () => this.playerLoaded = true;
                
                // æ•Œäººå›¾åƒ
                this.enemyImage = new Image();
                this.enemyImage.src = '/images/deoxys.png';
                this.enemyImage.onload = () => this.enemyLoaded = true;
            }
            
            loadSounds() {
                // èƒŒæ™¯éŸ³ä¹
                this.bgMusic = new Audio('/sounds/background_music.mp3');
                this.bgMusic.loop = true;
                
                // å°„å‡»éŸ³æ•ˆ
                this.playerShootSound = new Audio('/sounds/player_shoot.mp3');
                this.enemyShootSound = new Audio('/sounds/enemy_shoot.mp3');
                
                // çˆ†ç‚¸éŸ³æ•ˆ
                this.explosionSound = new Audio('/sounds/explosion.mp3');
                
                // å‡çº§éŸ³æ•ˆ
                this.levelUpSound = new Audio('/sounds/level_up.mp3');
            }
            
            setupKeyboardControls() {
                document.addEventListener('keydown', (e) => {
                    // å¤„ç†æ¸¸æˆç»“æŸåçš„é‡æ–°å¼€å§‹
                    if (this.waitForRestart) {
                        this.init();
                        return;
                    }
                    
                    // å¤„ç†æ¸¸æˆæš‚åœçŠ¶æ€ä¸‹çš„æŒ‰é”®
                    if (this.gamePaused && e.key !== 'p') {
                        return;
                    }
                    
                    switch (e.key) {
                        case 'ArrowLeft':
                            this.playerPos.x = Math.max(0, this.playerPos.x - 15);
                            break;
                        case 'ArrowRight':
                            this.playerPos.x = Math.min(400 - this.playerSize, this.playerPos.x + 15);
                            break;
                        case 'ArrowUp':
                            this.playerPos.y = Math.max(0, this.playerPos.y - 15);
                            break;
                        case 'ArrowDown':
                            this.playerPos.y = Math.min(600 - this.playerSize * 1.2, this.playerPos.y + 15);
                            break;
                        case ' ': // ç©ºæ ¼é”®
                            // ä»megaè£‚ç©ºåº§çš„å£éƒ¨ä½ç½®å‘å°„é¾™æ¯å…‰çº¿
                            this.bullets.push({
                                x: this.playerPos.x + this.playerSize / 2,
                                y: this.playerPos.y + this.playerSize / 4
                            });
                            
                            // æ’­æ”¾å°„å‡»éŸ³æ•ˆ
                            this.playerShootSound.currentTime = 0;
                            this.playerShootSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
                            break;
                        case 'p':
                            this.gamePaused = !this.gamePaused;
                            
                            // å¤„ç†èƒŒæ™¯éŸ³ä¹
                            if (this.gamePaused) {
                                this.bgMusic.pause();
                            } else {
                                this.bgMusic.play().catch(e => console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:", e));
                            }
                            break;
                    }
                });
            }
            
            setupTouchControls() {
                // è§¦æ‘¸æ§åˆ¶åŒºåŸŸ
                const touchZones = {
                    left: {x: 0, y: this.canvas.height - 100, width: 100, height: 100},
                    right: {x: 100, y: this.canvas.height - 100, width: 100, height: 100},
                    up: {x: 0, y: this.canvas.height - 200, width: 100, height: 100},
                    down: {x: 100, y: this.canvas.height - 200, width: 100, height: 100},
                    fire: {x: this.canvas.width - 100, y: this.canvas.height - 100, width: 100, height: 100},
                    pause: {x: this.canvas.width - 100, y: 0, width: 100, height: 50}
                };
                
                // ç»˜åˆ¶è§¦æ‘¸æ§åˆ¶åŒºåŸŸ
                this.drawTouchControls = () => {
                    this.ctx.globalAlpha = 0.3;
                    
                    // æ–¹å‘é”®
                    this.ctx.fillStyle = 'gray';
                    this.ctx.fillRect(touchZones.left.x, touchZones.left.y, touchZones.left.width, touchZones.left.height);
                    this.ctx.fillRect(touchZones.right.x, touchZones.right.y, touchZones.right.width, touchZones.right.height);
                    this.ctx.fillRect(touchZones.up.x, touchZones.up.y, touchZones.up.width, touchZones.up.height);
                    this.ctx.fillRect(touchZones.down.x, touchZones.down.y, touchZones.down.width, touchZones.down.height);
                    
                    // å°„å‡»æŒ‰é’®
                    this.ctx.fillStyle = 'red';
                    this.ctx.fillRect(touchZones.fire.x, touchZones.fire.y, touchZones.fire.width, touchZones.fire.height);
                    
                    // æš‚åœæŒ‰é’®
                    this.ctx.fillStyle = 'blue';
                    this.ctx.fillRect(touchZones.pause.x, touchZones.pause.y, touchZones.pause.width, touchZones.pause.height);
                    
                    // æŒ‰é’®å›¾æ ‡
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '24px Arial';
                    this.ctx.fillText('â†', touchZones.left.x + 40, touchZones.left.y + 60);
                    this.ctx.fillText('â†’', touchZones.right.x + 40, touchZones.right.y + 60);
                    this.ctx.fillText('â†‘', touchZones.up.x + 40, touchZones.up.y + 60);
                    this.ctx.fillText('â†“', touchZones.down.x + 40, touchZones.down.y + 60);
                    this.ctx.fillText('ğŸ”¥', touchZones.fire.x + 40, touchZones.fire.y + 60);
                    this.ctx.fillText('â¸ï¸', touchZones.pause.x + 40, touchZones.pause.y + 30);
                    
                    this.ctx.globalAlpha = 1.0;
                };
                
                // è§¦æ‘¸äº‹ä»¶å¤„ç†
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    
                    // å¤„ç†æ¸¸æˆç»“æŸåçš„é‡æ–°å¼€å§‹
                    if (this.waitForRestart) {
                        this.init();
                        return;
                    }
                    
                    for (let i = 0; i < e.touches.length; i++) {
                        const touch = e.touches[i];
                        const x = touch.clientX - this.canvas.getBoundingClientRect().left;
                        const y = touch.clientY - this.canvas.getBoundingClientRect().top;
                        
                        // è°ƒæ•´åæ ‡ä»¥é€‚åº”ç”»å¸ƒç¼©æ”¾
                        const scaleX = this.canvas.width / this.canvas.clientWidth;
                        const scaleY = this.canvas.height / this.canvas.clientHeight;
                        const canvasX = x * scaleX;
                        const canvasY = y * scaleY;
                        
                        // æ£€æŸ¥è§¦æ‘¸ä½ç½®
                        if (this.isInZone(canvasX, canvasY, touchZones.pause)) {
                            this.gamePaused = !this.gamePaused;
                            if (this.gamePaused) {
                                this.bgMusic.pause();
                            } else {
                                this.bgMusic.play().catch(e => console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:", e));
                            }
                            continue;
                        }
                        
                        // å¦‚æœæ¸¸æˆæš‚åœï¼Œä¸å¤„ç†å…¶ä»–è§¦æ‘¸
                        if (this.gamePaused) continue;
                        
                        if (this.isInZone(canvasX, canvasY, touchZones.left)) {
                            this.playerPos.x = Math.max(0, this.playerPos.x - 15);
                        }
                        if (this.isInZone(canvasX, canvasY, touchZones.right)) {
                            this.playerPos.x = Math.min(400 - this.playerSize, this.playerPos.x + 15);
                        }
                        if (this.isInZone(canvasX, canvasY, touchZones.up)) {
                            this.playerPos.y = Math.max(0, this.playerPos.y - 15);
                        }
                        if (this.isInZone(canvasX, canvasY, touchZones.down)) {
                            this.playerPos.y = Math.min(600 - this.playerSize * 1.2, this.playerPos.y + 15);
                        }
                        if (this.isInZone(canvasX, canvasY, touchZones.fire)) {
                            // ä»megaè£‚ç©ºåº§çš„å£éƒ¨ä½ç½®å‘å°„é¾™æ¯å…‰çº¿
                            this.bullets.push({
                                x: this.playerPos.x + this.playerSize / 2,
                                y: this.playerPos.y + this.playerSize / 4
                            });
                            
                            // æ’­æ”¾å°„å‡»éŸ³æ•ˆ
                            this.playerShootSound.currentTime = 0;
                            this.playerShootSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
                        }
                    }
                });
                
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    
                    if (this.gamePaused || this.waitForRestart) return;
                    
                    for (let i = 0; i < e.touches.length; i++) {
                        const touch = e.touches[i];
                        const x = touch.clientX - this.canvas.getBoundingClientRect().left;
                        const y = touch.clientY - this.canvas.getBoundingClientRect().top;
                        
                        // è°ƒæ•´åæ ‡ä»¥é€‚åº”ç”»å¸ƒç¼©æ”¾
                        const scaleX = this.canvas.width / this.canvas.clientWidth;
                        const scaleY = this.canvas.height / this.canvas.clientHeight;
                        const canvasX = x * scaleX;
                        const canvasY = y * scaleY;
                        
                        if (this.isInZone(canvasX, canvasY, touchZones.left)) {
                            this.playerPos.x = Math.max(0, this.playerPos.x - 15);
                        }
                        if (this.isInZone(canvasX, canvasY, touchZones.right)) {
                            this.playerPos.x = Math.min(400 - this.playerSize, this.playerPos.x + 15);
                        }
                        if (this.isInZone(canvasX, canvasY, touchZones.up)) {
                            this.playerPos.y = Math.max(0, this.playerPos.y - 15);
                        }
                        if (this.isInZone(canvasX, canvasY, touchZones.down)) {
                            this.playerPos.y = Math.min(600 - this.playerSize * 1.2, this.playerPos.y + 15);
                        }
                        if (this.isInZone(canvasX, canvasY, touchZones.fire)) {
                            if (Math.random() < 0.2) { // é™ä½è§¦æ‘¸å°„å‡»çš„é¢‘ç‡
                                this.bullets.push({
                                    x: this.playerPos.x + this.playerSize / 2,
                                    y: this.playerPos.y + this.playerSize / 4
                                });
                                
                                this.playerShootSound.currentTime = 0;
                                this.playerShootSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
                            }
                        }
                    }
                });
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†æ¸¸æˆç»“æŸé‡å¯
                this.canvas.addEventListener('click', () => {
                    if (this.waitForRestart) {
                        this.init();
                    }
                });
            }
            
            isInZone(x, y, zone) {
                return x >= zone.x && x <= zone.x + zone.width && 
                       y >= zone.y && y <= zone.y + zone.height;
            }
            
            init() {
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                this.gameActive = true;
                this.gamePaused = false;
                this.waitForRestart = false;
                this.playerPos = {x: 160, y: 450};
                this.bullets = [];
                this.enemies = [];
                this.enemyBullets = [];
                this.score = 0;
                this.lives = 3;
                this.level = 1;
                this.nextLevelScore = 20;
                this.enemySpeed = 2;
                this.spawnRate = 0.03;
                this.enemyFireRate = 0.01;
                
                // éšè—æ¸¸æˆç»“æŸå±å¹•
                this.gameOverScreen.style.display = 'none';
                
                // å¼€å§‹èƒŒæ™¯éŸ³ä¹
                this.bgMusic.play().catch(e => console.log("èƒŒæ™¯éŸ³ä¹æ’­æ”¾å¤±è´¥:", e));
                
                // å¼€å§‹æ¸¸æˆå¾ªç¯
                requestAnimationFrame(this.gameLoop.bind(this));
            }
            
            gameLoop(timestamp) {
                // è®¡ç®—å¸§é—´éš”
                const deltaTime = timestamp - this.lastTime;
                this.lastTime = timestamp;
                
                // æ£€æŸ¥æ¸¸æˆæš‚åœçŠ¶æ€
                if (this.gamePaused) {
                    // åœ¨æš‚åœçŠ¶æ€ä¸‹æ˜¾ç¤ºæš‚åœæ–‡æœ¬
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    this.ctx.font = '30px Arial';
                    this.ctx.fillStyle = 'white';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('æ¸¸æˆæš‚åœ', this.canvas.width / 2, this.canvas.height / 2);
                    this.ctx.textAlign = 'left';
                    
                    // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ˜¾ç¤ºè§¦æ‘¸æ§åˆ¶
                    if ('ontouchstart' in window) {
                        this.drawTouchControls();
                    }
                    
                    requestAnimationFrame(this.gameLoop.bind(this));
                    return;
                }
                
                // æ¸…é™¤å±å¹•
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç»˜åˆ¶èƒŒæ™¯
                if (this.bgLoaded) {
                    this.ctx.drawImage(this.bgImage, 0, 0, 400, 600);
                } else {
                    this.ctx.fillStyle = 'black';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }
                
                // ç”Ÿæˆæ–°çš„æ•Œäºº
                if (Math.random() < this.spawnRate) {
                    const x = Math.random() * (400 - this.enemySize);
                    this.enemies.push({x: x, y: 0});
                }
                
                // ç»˜åˆ¶ç©å®¶
                this.drawPlayer();
                
                // å¤„ç†ç©å®¶å­å¼¹
                this.updateBullets();
                
                // å¤„ç†æ•Œäºº
                this.updateEnemies();
                
                // å¤„ç†æ•Œäººå­å¼¹
                this.updateEnemyBullets();
                
                // ç»˜åˆ¶æ¸¸æˆä¿¡æ¯é¢æ¿
                this.drawInfoPanel();
                
                // ç­‰çº§æå‡æ£€æŸ¥
                if (this.score >= this.nextLevelScore) {
                    this.levelUp();
                    this.nextLevelScore = this.nextLevelScore * 2;
                }
                
                // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ˜¾ç¤ºè§¦æ‘¸æ§åˆ¶
                if ('ontouchstart' in window) {
                    this.drawTouchControls();
                }
                
                // ç»§ç»­æ¸¸æˆå¾ªç¯
                if (this.gameActive) {
                    requestAnimationFrame(this.gameLoop.bind(this));
                }
            }
            
            drawPlayer() {
                if (this.playerLoaded) {
                    this.ctx.drawImage(this.playerImage, 
                        this.playerPos.x, this.playerPos.y, 
                        this.playerSize, this.playerSize);
                } else {
                    // å¤‡ç”¨ç»˜å›¾æ–¹æ¡ˆ
                    this.ctx.fillStyle = 'green';
                    this.ctx.fillRect(this.playerPos.x, this.playerPos.y, 
                        this.playerSize, this.playerSize);
                }
            }
            
            updateBullets() {
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    // ç§»åŠ¨å­å¼¹
                    this.bullets[i].y -= this.bulletSpeed;
                    
                    // æ£€æŸ¥å‡ºç•Œçš„å­å¼¹
                    if (this.bullets[i].y < 0) {
                        this.bullets.splice(i, 1);
                        continue;
                    }
                    
                    // ç»˜åˆ¶å­å¼¹ï¼ˆé¾™æ¯å…‰çº¿å½¢å¼ï¼‰
                    const x = this.bullets[i].x;
                    const y = this.bullets[i].y;
                    const rayLen = 40;
                    
                    // æ ¸å¿ƒå…‰çº¿
                    this.ctx.lineWidth = 5;
                    this.ctx.strokeStyle = 'rgba(0, 180, 255, 1)';
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - 1, y);
                    this.ctx.lineTo(x + 1, y - rayLen);
                    this.ctx.stroke();
                    
                    // å¤–å›´å…‰èŠ’
                    this.ctx.lineWidth = 8;
                    this.ctx.strokeStyle = 'rgba(0, 128, 255, 0.5)';
                    this.ctx.beginPath();
                    this.ctx.moveTo(x - 3, y);
                    this.ctx.lineTo(x + 3, y - rayLen * 0.8);
                    this.ctx.stroke();
                    
                    // å…‰çº¿å¤´éƒ¨ç‰¹æ•ˆ
                    this.ctx.fillStyle = 'rgba(0, 180, 255, 0.7)';
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, 5, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // æ£€æŸ¥å­å¼¹æ˜¯å¦å‡»ä¸­æ•Œäºº
                    for (let j = this.enemies.length - 1; j >= 0; j--) {
                        const enemy = this.enemies[j];
                        
                        // æ£€æŸ¥ç¢°æ’
                        if (this.checkCollision(
                            {x: x - 5, y: y - rayLen}, 12,
                            {x: enemy.x, y: enemy.y}, this.enemySize
                        )) {
                            // åˆ é™¤æ•Œäºº
                            this.enemies.splice(j, 1);
                            
                            // å¢åŠ åˆ†æ•°
                            this.score += 5;
                            
                            // çˆ†ç‚¸æ•ˆæœ
                            this.drawExplosion(enemy.x + this.enemySize/2, enemy.y + this.enemySize/2, this.enemySize);
                            
                            // æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆ
                            this.explosionSound.currentTime = 0;
                            this.explosionSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
                            
                            // åˆ é™¤å­å¼¹
                            this.bullets.splice(i, 1);
                            break;
                        }
                    }
                }
            }
            
            updateEnemies() {
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    // ç§»åŠ¨æ•Œäºº
                    this.enemies[i].y += this.enemySpeed;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ•Œäººåˆ°è¾¾åº•éƒ¨
                    if (this.enemies[i].y > 600 - this.enemySize) {
                        // åˆ é™¤åˆ°è¾¾åº•éƒ¨çš„æ•Œäºº
                        this.enemies.splice(i, 1);
                        
                        // å‡å°‘ç”Ÿå‘½å€¼
                        this.lives--;
                        if (this.lives <= 0) {
                            this.gameOver();
                            return;
                        }
                        continue;
                    }
                    
                    const enemy = this.enemies[i];
                    
                    // ç»˜åˆ¶æ•Œäºº
                    if (this.enemyLoaded) {
                        this.ctx.drawImage(this.enemyImage, 
                            enemy.x, enemy.y, this.enemySize, this.enemySize);
                    } else {
                        // å¤‡ç”¨ç»˜å›¾æ–¹æ¡ˆ
                        this.ctx.fillStyle = 'red';
                        this.ctx.fillRect(enemy.x, enemy.y, this.enemySize, this.enemySize);
                    }
                    
                    // æ•Œäººå‘å°„æ”»å‡»
                    if (Math.random() < this.enemyFireRate) {
                        // ä»æ•Œäººä½ç½®å‘å°„è¶…èƒ½åŠ›çƒ
                        this.enemyBullets.push({
                            x: enemy.x + this.enemySize / 2,
                            y: enemy.y + this.enemySize / 2
                        });
                        
                        // æ’­æ”¾æ•Œäººå°„å‡»éŸ³æ•ˆ
                        this.enemyShootSound.currentTime = 0;
                        this.enemyShootSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
                    }
                }
            }
            
            updateEnemyBullets() {
                for (let i = this.enemyBullets.length - 1; i >= 0; i--) {
                    // ç§»åŠ¨æ•Œäººå­å¼¹
                    this.enemyBullets[i].y += this.enemyBulletSpeed;
                    
                    // æ£€æŸ¥å‡ºç•Œçš„æ•Œäººå­å¼¹
                    if (this.enemyBullets[i].y > 600) {
                        this.enemyBullets.splice(i, 1);
                        continue;
                    }
                    
                    const bullet = this.enemyBullets[i];
                    
                    // ç»˜åˆ¶è¶…èƒ½åŠ›çƒ
                    const ballSize = this.enemyBulletSize;
                    
                    // çƒä½“å…‰æ™•æ•ˆæœ
                    this.ctx.fillStyle = 'rgba(255, 77, 255, 0.3)';
                    this.ctx.beginPath();
                    this.ctx.arc(bullet.x, bullet.y, ballSize * 1.5, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // ä¸»çƒä½“
                    this.ctx.fillStyle = 'rgba(255, 77, 255, 1)';
                    this.ctx.beginPath();
                    this.ctx.arc(bullet.x, bullet.y, ballSize, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // æ£€æŸ¥æ˜¯å¦å‡»ä¸­ç©å®¶
                    if (this.checkCollision(
                        {x: this.playerPos.x, y: this.playerPos.y}, this.playerSize,
                        {x: bullet.x, y: bullet.y}, ballSize * 2
                    )) {
                        // çˆ†ç‚¸æ•ˆæœ
                        this.drawExplosion(
                            this.playerPos.x + this.playerSize/2, 
                            this.playerPos.y + this.playerSize/2, 
                            this.playerSize/2
                        );
                        
                        // æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆ
                        this.explosionSound.currentTime = 0;
                        this.explosionSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
                        
                        // å‡å°‘ç”Ÿå‘½å€¼
                        this.lives--;
                        if (this.lives <= 0) {
                            this.gameOver();
                            return;
                        }
                        
                        // åˆ é™¤å­å¼¹
                        this.enemyBullets.splice(i, 1);
                    }
                }
            }
            
            drawExplosion(x, y, size) {
                const colors = [
                    'rgba(255, 179, 51, 1)',
                    'rgba(255, 128, 26, 1)',
                    'rgba(255, 77, 26, 1)',
                    'rgba(230, 26, 26, 1)'
                ];
                
                for (let r = 1; r <= 4; r++) {
                    for (let i = 1; i <= 8; i++) {
                        const angle = i * Math.PI / 4;
                        const distance = size * r / 4;
                        const xp = x + Math.cos(angle) * distance * (0.7 + 0.3 * Math.random());
                        const yp = y + Math.sin(angle) * distance * (0.7 + 0.3 * Math.random());
                        const rad = size * (0.3 - r * 0.05) * (0.7 + 0.3 * Math.random());
                        
                        this.ctx.fillStyle = colors[r - 1];
                        this.ctx.beginPath();
                        this.ctx.arc(xp, yp, rad, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                }
            }
            
                        drawInfoPanel() {
                // ç»˜åˆ¶åŠé€æ˜èƒŒæ™¯
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                this.ctx.fillRect(0, 0, 150, 80);
                
                // ç»˜åˆ¶æ–‡æœ¬
                this.ctx.fillStyle = 'white';
                this.ctx.font = '16px Arial';
                this.ctx.fillText(`åˆ†æ•°: ${this.score}`, 10, 25);
                this.ctx.fillText(`ç”Ÿå‘½: ${this.lives}`, 10, 50);
                this.ctx.fillText(`ç­‰çº§: ${this.level}`, 10, 75);
            }
            
            levelUp() {
                // æé«˜éš¾åº¦
                this.level++;
                this.enemySpeed *= 1.1;
                this.spawnRate = Math.min(this.spawnRate * 1.2, 0.1);
                this.enemyFireRate = Math.min(this.enemyFireRate * 1.2, 0.05);
                
                // æ˜¾ç¤ºå‡çº§æ–‡æœ¬
                this.ctx.font = '24px Arial';
                this.ctx.fillStyle = 'yellow';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(`å‡çº§åˆ° ${this.level} çº§!`, 200, 200);
                this.ctx.textAlign = 'left';
                
                // æ’­æ”¾å‡çº§éŸ³æ•ˆ
                this.levelUpSound.currentTime = 0;
                this.levelUpSound.play().catch(e => console.log("éŸ³æ•ˆæ’­æ”¾å¤±è´¥:", e));
            }
            
            gameOver() {
                // åœæ­¢èƒŒæ™¯éŸ³ä¹
                this.bgMusic.pause();
                
                // æ˜¾ç¤ºæ¸¸æˆç»“æŸå±å¹•
                this.gameOverScreen.style.display = 'block';
                this.finalScoreText.textContent = `æœ€ç»ˆåˆ†æ•°: ${this.score}`;
                
                // è®¾ç½®ç­‰å¾…é‡æ–°å¼€å§‹æ ‡å¿—
                this.waitForRestart = true;
                this.gameActive = false;
            }
            
            checkCollision(pos1, sz1, pos2, sz2) {
                return !(
                    pos1.x + sz1 < pos2.x || 
                    pos2.x + sz2 < pos1.x || 
                    pos1.y + sz1 < pos2.y || 
                    pos2.y + sz2 < pos1.y
                );
            }
        }
        
        // å½“é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æ¸¸æˆ
        window.onload = function() {
            // ä¸ºç§»åŠ¨è®¾å¤‡æ·»åŠ ç‰¹æ®Šå¤„ç†
            if ('ontouchstart' in window) {
                // é˜»æ­¢åŒå‡»ç¼©æ”¾
                document.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                }, { passive: false });
                
                // é˜»æ­¢é»˜è®¤æ»šåŠ¨è¡Œä¸º
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                
                // è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘çš„ç‰¹æ®Šå¤„ç†
                document.addEventListener('touchstart', function() {
                    // åˆ›å»ºé™éŸ³éŸ³é¢‘å¹¶æ’­æ”¾ï¼Œè§£é”éŸ³é¢‘API
                    const silentSound = new Audio();
                    silentSound.play().catch(e => {});
                }, { once: true });
            }
            
            // åˆå§‹åŒ–æ¸¸æˆ
            const game = new PokemonSpaceGame();
            
            // é€‚é…ä¸åŒå±å¹•å°ºå¯¸
            function resizeCanvas() {
                const canvas = document.getElementById('gameCanvas');
                const gameOverScreen = document.getElementById('gameOverScreen');
                
                // è®¡ç®—é€‚åˆçª—å£çš„å°ºå¯¸ï¼Œä¿æŒæ¯”ä¾‹
                const windowRatio = window.innerWidth / window.innerHeight;
                const gameRatio = 400 / 600;
                
                let newWidth, newHeight;
                
                if (windowRatio > gameRatio) {
                    // çª—å£æ›´å®½ï¼Œä»¥é«˜åº¦ä¸ºåŸºå‡†
                    newHeight = Math.min(window.innerHeight, 600);
                    newWidth = newHeight * gameRatio;
                } else {
                    // çª—å£æ›´é«˜ï¼Œä»¥å®½åº¦ä¸ºåŸºå‡†
                    newWidth = Math.min(window.innerWidth, 400);
                    newHeight = newWidth / gameRatio;
                }
                
                // è®¾ç½®ç”»å¸ƒCSSå°ºå¯¸ï¼ˆæ˜¾ç¤ºå°ºå¯¸ï¼‰
                canvas.style.width = `${newWidth}px`;
                canvas.style.height = `${newHeight}px`;
                
                // è®¾ç½®æ¸¸æˆç»“æŸå±å¹•ä½ç½®
                gameOverScreen.style.top = `${(window.innerHeight - newHeight) / 2 + newHeight / 3}px`;
                gameOverScreen.style.left = `${(window.innerWidth - newWidth) / 2 + newWidth / 4}px`;
                gameOverScreen.style.width = `${newWidth / 2}px`;
            }
            
            // åˆå§‹è°ƒæ•´å’Œç›‘å¬çª—å£å¤§å°å˜åŒ–
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        };
    </script>
</body>
</html>

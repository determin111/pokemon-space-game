<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂÆùÂèØÊ¢¶Â§™Á©∫ÂØπÊàò</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            font-family: Arial, sans-serif;
        }

        #gameCanvas {
            border: 1px solid #333;
            max-width: 100%;
            max-height: 100%;
            display: none;
        }

        #intro-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            text-align: center;
            z-index: 1000;
            cursor: pointer;
        }

        #intro-video {
            max-width: 80%;
            max-height: 60%;
            margin-bottom: 20px;
        }

        .game-over {
            position: absolute;
            color: white;
            text-align: center;
            display: none;
        }

        .game-over h1 {
            color: red;
            font-size: 30px;
        }

        .game-over p {
            font-size: 20px;
            margin: 10px 0;
        }

        #joystick {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 100px;
            height: 100px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            display: none;
        }

        #joystick-handle {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            position: absolute;
        }

        #fire-button {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            user-select: none;
            display: none;
        }

        #pause-button {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 60px;
            height: 40px;
            background-color: rgba(0, 0, 255, 0.7);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            user-select: none;
            display: none;
        }

        #leaderboard {
            position: absolute;
            top: 80px;
            left: 30px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
        }

        #leaderboard h2 {
            margin-top: 0;
            font-size: 20px;
        }

        #leaderboard ol {
            padding-left: 20px;
        }

        #leaderboard li {
            font-size: 16px;
            margin-bottom: 5px;
        }

        #show-leaderboard-button {
            position: absolute;
            top: 30px;
            left: 30px;
            width: 100px;
            height: 40px;
            background-color: rgba(0, 255, 0, 0.7);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: black;
            font-size: 14px;
            user-select: none;
            cursor: pointer;
            display: none;
        }
    </style>
</head>

<body>
    <div id="intro-screen">
        <video id="intro-video" src="videos/pokemon_intro.mp4" preload="metadata"></video>
        <h1>ÂÆùÂèØÊ¢¶Â§™Á©∫ÂØπÊàò</h1>
        <p>ÁÇπÂáªÊàñËß¶Êë∏Â±èÂπïÂºÄÂßã</p>
    </div>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <div class="game-over" id="gameOverScreen">
        <h1>Ê∏∏ÊàèÁªìÊùü</h1>
        <p id="finalScore">ÊúÄÁªàÂàÜÊï∞: 0</p>
        <p>Êåâ‰ªªÊÑèÈîÆÊàñÁÇπÂáªÂ±èÂπïÈáçÊñ∞ÂºÄÂßã</p>
    </div>

    <!-- ÊëáÊùÜ -->
    <div id="joystick">
        <div id="joystick-handle"></div>
    </div>
    <!-- Â∞ÑÂáªÊåâÈíÆ -->
    <div id="fire-button">üî•</div>
    <!-- ÊöÇÂÅúÊåâÈíÆ -->
    <div id="pause-button">‚è∏Ô∏è</div>

    <!-- ÊéíË°åÊ¶ú -->
    <div id="leaderboard">
        <h2>ÊéíË°åÊ¶ú</h2>
        <ol id="leaderboard-list"></ol>
    </div>

    <!-- ÊòæÁ§∫ÊéíË°åÊ¶úÊåâÈíÆ -->
    <div id="show-leaderboard-button">Êü•ÁúãÊéíË°åÊ¶ú</div>

    <script>
        console.log("JavaScript file loaded and running");
        class PokemonSpaceGame {
            constructor() {
                // Canvas and Game Over elements
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gameOverScreen = document.getElementById('gameOverScreen');
                this.finalScoreText = document.getElementById('finalScore');
                this.introScreen = document.getElementById('intro-screen');
                this.introVideo = document.getElementById('intro-video');

                // Leaderboard elements
                this.leaderboardElement = document.getElementById('leaderboard');
                this.leaderboardList = document.getElementById('leaderboard-list');
                this.showLeaderboardButton = document.getElementById('show-leaderboard-button');

                // Game state
                this.gameActive = false;
                this.gamePaused = false;
                this.waitForRestart = false;
                this.score = 0;
                this.lives = 7;
                this.level = 1;
                this.nextLevelScore = 25;
                this.invulnerable = false;
                this.invulnerableTimer = 0;
                this.characterLevel = 1;
                this.maxCharacterLevel = 6;
                this.inIntro = true;
                this.introVideoStarted = false;

                // Player properties
                this.playerSize = 80;
                this.playerPos = { x: 160, y: 450 };
                this.playerSpeed = 5;
                this.bullets = [];
                this.bulletSpeed = 9;
                this.laserActive = false;
                this.laserTimer = 0;
                this.laserDamage = 10;

                // Enemy properties
                this.enemies = [];
                this.enemySize = 50;
                this.enemySpeed = 1.2;
                this.spawnRate = 0.012;
                this.maxEnemies = 4;
                this.enemyFireRate = 0.006;
                this.enemyBullets = [];
                this.enemyBulletSpeed = 2.7;
                this.enemyBulletSize = 8;

                // Leaderboard data
                this.leaderboardData = this.loadLeaderboard();

                // Images
                this.loadImages();

                // Sounds
                this.loadSounds();

                // Input
                this.setupKeyboardControls();
                this.setupTouchControls();

                // Event listeners
                this.introScreen.addEventListener('click', this.handleIntroClick.bind(this));
                this.introScreen.addEventListener('touchstart', this.handleIntroClick.bind(this));
                this.showLeaderboardButton.addEventListener('click', this.toggleLeaderboard.bind(this));

                console.log("Event listeners attached.");
                this.lastTime = 0;
                this.init();
            }

            /* Enemy Methods ************************************************************************************* */
            fireEnemyShotgun(enemy) {
                for (let i = -1; i <= 1; i++) {
                    const angle = (i * 15) * Math.PI / 180;
                    this.enemyBullets.push({
                        x: enemy.x + this.enemySize / 2,
                        y: enemy.y + this.enemySize,
                        angle: angle
                    });
                }
            }

            /* Game Draw Methods ************************************************************************************* */
            drawPlayer() {
                if (!this.gameActive) return;

                if (this.playerLoaded) {
                    if (this.invulnerable && Math.floor(Date.now() / 100) % 2) {
                        return;
                    }
                    this.ctx.drawImage(this.playerImage, this.playerPos.x, this.playerPos.y, this.playerSize, this.playerSize);
                } else {
                    this.ctx.fillStyle = 'green';
                    if (this.invulnerable && Math.floor(Date.now() / 100) % 2) {
                        return;
                    }
                    this.ctx.fillRect(this.playerPos.x, this.playerPos.y, this.playerSize, this.playerSize);
                }
            }

            drawInfoPanel() {
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                this.ctx.fillRect(0, 0, 150, 120);

                this.ctx.fillStyle = 'white';
                this.ctx.font = '12px Arial';
                this.ctx.fillText(`ÂàÜÊï∞: ${this.score}`, 10, 20);
                this.ctx.fillText(`ÁîüÂëΩ: ${this.lives}`, 10, 40);
                this.ctx.fillText(`Ê∏∏ÊàèÁ≠âÁ∫ß: ${this.level}`, 10, 60);
                this.ctx.fillText(`ËßíËâ≤Á≠âÁ∫ß: ${this.characterLevel}`, 10, 80);

                this.ctx.fillStyle = this.invulnerable ? 'yellow' : 'white';
                this.ctx.fillText(`Êó†Êïå: ${this.invulnerable ? this.invulnerableTimer.toFixed(1) : 'Âê¶'}`, 10, 100);

                this.ctx.font = '8px Arial';
            }

            drawExplosion(x, y, size) {
                const colors = [
                    'rgba(255, 179, 51, 1)',
                    'rgba(255, 128, 26, 1)',
                    'rgba(255, 77, 26, 1)',
                    'rgba(230, 26, 26, 1)'
                ];

                for (let r = 1; r <= 4; r++) {
                    for (let j = 1; j <= 8; j++) {
                        const angle = j * Math.PI / 4;
                        const distance = size * r / 4;
                        const xp = x + Math.cos(angle) * distance * (0.7 + 0.3 * Math.random());
                        const yp = y + Math.sin(angle) * distance * (0.7 + 0.3 * Math.random());
                        const rad = size * (0.3 - r * 0.05) * (0.7 + 0.3 * Math.random());

                        this.ctx.fillStyle = colors[r - 1];
                        this.ctx.beginPath();
                        this.ctx.arc(xp, yp, rad, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                }
            }

            drawLaser() {
                const laserWidth = 15;
                const centerX = this.playerPos.x + this.playerSize / 2;
                
                // Â§ñÂ±ÇÂÖâÊôï
                this.ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
                this.ctx.fillRect(centerX - laserWidth, 0, laserWidth * 2, this.playerPos.y);
                
                // ‰∏≠Â±ÇÊøÄÂÖâ
                this.ctx.fillStyle = 'rgba(255, 100, 100, 0.7)';
                this.ctx.fillRect(centerX - laserWidth/2, 0, laserWidth, this.playerPos.y);
                
                // Ê†∏ÂøÉÊøÄÂÖâ
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                this.ctx.fillRect(centerX - laserWidth/4, 0, laserWidth/2, this.playerPos.y);
            }

            /* Update Methods ************************************************************************************* */
            updateLaser(deltaTime) {
                if (this.laserActive) {
                    this.drawLaser();
                    this.laserTimer -= deltaTime / 1000;
                    if (this.laserTimer <= 0) {
                        this.laserActive = false;
                        this.laserTimer = 0;
                    }
                    this.laserCollisionDetection();
                }
            }

            updateEnemies(deltaTime) {
                if (!this.gameActive) return;

                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    const enemyRect = { x: enemy.x, y: enemy.y, width: this.enemySize, height: this.enemySize };
                    
                    // Ê£ÄÊü•‰∏éÁé©ÂÆ∂ÁöÑÁ¢∞Êíû
                    const playerRect = { x: this.playerPos.x, y: this.playerPos.y, width: this.playerSize, height: this.playerSize };
                    if (!this.invulnerable && this.checkCollision(playerRect, enemyRect)) {
                        this.handlePlayerHit(i);
                        continue;
                    }

                    enemy.y += this.enemySpeed;
                    if (enemy.y > this.canvas.height) {
                        this.enemies.splice(i, 1);
                        continue;
                    }

                    // ÁªòÂà∂Êïå‰∫∫
                    if (this.enemyLoaded) {
                        this.ctx.drawImage(this.enemyImage, enemy.x, enemy.y, this.enemySize, this.enemySize);
                    } else {
                        this.ctx.fillStyle = 'red';
                        this.ctx.fillRect(enemy.x, enemy.y, this.enemySize, this.enemySize);
                    }

                    // Êïå‰∫∫Â∞ÑÂáª - 7Á∫ßÂºÄÂßãÂèëÂ∞ÑÊï£Âºπ
                    if (this.level >= 7 && Math.random() < this.enemyFireRate && this.gameActive) {
                        this.fireEnemyShotgun(enemy);
                        this.enemyShootSound.currentTime = 0;
                        this.enemyShootSound.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));
                    } else if (Math.random() < this.enemyFireRate && this.gameActive) {
                        this.enemyBullets.push({
                            x: enemy.x + this.enemySize / 2,
                            y: enemy.y + this.enemySize
                        });
                        this.enemyShootSound.currentTime = 0;
                        this.enemyShootSound.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));
                    }
                }

                if (this.invulnerable) {
                    this.invulnerableTimer -= deltaTime / 1000;
                    if (this.invulnerableTimer <= 0) {
                        this.invulnerable = false;
                        this.invulnerableTimer = 0;
                    }
                }
            }

            handlePlayerHit(enemyIndex) {
                this.drawExplosion(
                    this.playerPos.x + this.playerSize / 2,
                    this.playerPos.y + this.playerSize / 2,
                    this.playerSize / 2
                );
                this.explosionSound.currentTime = 0;
                this.explosionSound.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));

                this.lives--;
                this.enemies.splice(enemyIndex, 1);

                if (this.lives <= 0) {
                    this.gameOver();
                    return;
                }

                this.invulnerable = true;
                this.invulnerableTimer = 2;
            }

            updateEnemyBullets() {
                for (let i = this.enemyBullets.length - 1; i >= 0; i--) {
                    const bullet = this.enemyBullets[i];

                    if (bullet.angle) {
                        bullet.x += Math.sin(bullet.angle) * this.enemyBulletSpeed;
                        bullet.y += Math.cos(bullet.angle) * this.enemyBulletSpeed;
                    } else {
                        bullet.y += this.enemyBulletSpeed;
                    }

                    if (bullet.y > this.canvas.height || bullet.x < 0 || bullet.x > this.canvas.width) {
                        this.enemyBullets.splice(i, 1);
                        continue;
                    }

                    const ballSize = this.enemyBulletSize;
                    this.ctx.fillStyle = 'rgba(255, 77, 255, 0.3)';
                    this.ctx.beginPath();
                    this.ctx.arc(bullet.x, bullet.y, ballSize * 1.5, 0, Math.PI * 2);
                    this.ctx.fill();

                    this.ctx.fillStyle = 'rgba(255, 77, 255, 1)';
                    this.ctx.beginPath();
                    this.ctx.arc(bullet.x, bullet.y, ballSize, 0, Math.PI * 2);
                    this.ctx.fill();

                    const playerRect = { x: this.playerPos.x, y: this.playerPos.y, width: this.playerSize, height: this.playerSize };
                    const bulletRect = { x: bullet.x - ballSize, y: bullet.y - ballSize, width: ballSize * 2, height: ballSize * 2 };

                    if (!this.invulnerable && this.checkCollision(playerRect, bulletRect)) {
                        this.handlePlayerHit(-1);
                        this.enemyBullets.splice(i, 1);
                    }
                }
            }

            updateBullets() {
                if (this.characterLevel < this.maxCharacterLevel) {
                    for (let i = this.bullets.length - 1; i >= 0; i--) {
                        this.bullets[i].y -= this.bulletSpeed;
                        if (this.bullets[i].y < -20) {
                            this.bullets.splice(i, 1);
                            continue;
                        }

                        const bullet = this.bullets[i];
                        const bulletWidth = 5;
                        const bulletHeight = 20;

                        this.ctx.fillStyle = 'red';
                        this.ctx.fillRect(bullet.x - bulletWidth / 2, bullet.y, bulletWidth, bulletHeight);

                        for (let j = this.enemies.length - 1; j >= 0; j--) {
                            const enemy = this.enemies[j];
                            if (this.checkCollision(
                                { x: bullet.x - bulletWidth / 2, y: bullet.y, width: bulletWidth, height: bulletHeight },
                                { x: enemy.x, y: enemy.y, width: this.enemySize, height: this.enemySize }
                            )) {
                                this.destroyEnemy(j, enemy);
                                this.bullets.splice(i, 1);
                                break;
                            }
                        }
                    }
                }
            }

            destroyEnemy(index, enemy) {
                this.enemies.splice(index, 1);
                this.score += 5;
                this.drawExplosion(enemy.x + this.enemySize / 2, enemy.y + this.enemySize / 2, this.enemySize);
                this.explosionSound.currentTime = 0;
                this.explosionSound.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));
            }

            /* Level methods ************************************************************************************* */
            levelUp() {
                this.level++;
                this.lives++;
                this.enemySpeed *= 1.04;
                this.spawnRate = Math.min(this.spawnRate * 1.08, 0.07);
                this.enemyFireRate = Math.min(this.enemyFireRate * 1.08, 0.035);
                this.characterLevelUp();

                this.ctx.font = '24px Arial';
                this.ctx.fillStyle = 'yellow';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(`Ê∏∏ÊàèÁ≠âÁ∫ß ${this.level} !`, this.canvas.width / 2, this.canvas.height / 2 - 30);
                this.ctx.textAlign = 'left';

                this.levelUpSound.currentTime = 0;
                this.levelUpSound.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));
            }

            /* Collision and Init methods ************************************************************************************* */
            checkCollision(rect1, rect2) {
                return rect1.x < rect2.x + rect2.width &&
                    rect1.x + rect1.width > rect2.x &&
                    rect1.y < rect2.y + rect2.height &&
                    rect1.y + rect1.height > rect2.y;
            }

            init() {
                this.spawnRate = 0.012;
                this.gameActive = false;
                this.gamePaused = false;
                this.waitForRestart = false;
                this.playerPos = { x: 160, y: 450 };
                this.bullets = [];
                this.enemies = [];
                this.enemyBullets = [];
                this.score = 0;
                this.lives = 7;
                this.level = 1;
                this.nextLevelScore = 25;
                this.enemySpeed = 1.2;
                this.enemyFireRate = 0.006;
                this.maxEnemies = 4;
                this.invulnerable = false;
                this.invulnerableTimer = 0;
                this.characterLevel = 1;
                this.laserActive = false;
                this.laserTimer = 0;

                this.gameOverScreen.style.display = 'none';
                this.leaderboardElement.style.display = 'none';

                if (this.bgMusic) {
                     this.bgMusic.pause();
                     this.bgMusic.currentTime = 0;
                }
                console.log("Game initialized/reset.");
            }

            /* Game Over and Char Level Methods ************************************************************************************* */
            gameOver() {
                let leaderboardEntry = {
                    name: "Âçï‰∫∫Áé©ÂÆ∂",
                    score: this.score
                };

                this.gameActive = false;
                if (this.bgMusic) this.bgMusic.pause();
                this.gameOverScreen.style.display = 'block';
                this.finalScoreText.textContent = `ÊúÄÁªàÂàÜÊï∞: ${this.score}`;
                this.addScoreToLeaderboard(leaderboardEntry);
                this.waitForRestart = true;
                console.log("Game Over. Waiting for restart.");
            }

            characterLevelUp() {
                if (this.characterLevel < this.maxCharacterLevel) {
                    this.characterLevel++;
                    this.invulnerable = true;
                    this.invulnerableTimer = 1;
                    console.log(`ËßíËâ≤ÂçáÁ∫ßÂà∞Á≠âÁ∫ß ${this.characterLevel}!`);
                    if (this.characterLevel === this.maxCharacterLevel) {
                        console.log("ËßíËâ≤ËææÂà∞ÊúÄÈ´òÁ≠âÁ∫ß! ÊîªÂáªÂèò‰∏∫ÊøÄÂÖâ!");
                        this.ctx.font = '20px Arial';
                        this.ctx.fillStyle = 'aqua';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(`ÊîªÂáªÂº∫Âåñ: ÊøÄÂÖâ!`, this.canvas.width / 2, this.canvas.height / 2);
                        this.ctx.textAlign = 'left';
                    }
                } else {
                    console.log("ËßíËâ≤Â∑≤ËææÂà∞ÊúÄÈ´òÁ≠âÁ∫ß!");
                }
            }

            /*Input and Loop Methods ************************************************************************************* */
            handleIntroClick(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!this.inIntro) {
                    console.log("Not in intro, ignoring click");
                    return;
                }
                
                if (this.introVideoStarted) {
                    console.log("Video already started, ignoring click");
                    return;
                }
                
                this.introVideoStarted = true;
                console.log("handleIntroClick called - starting video");

                const introTextH1 = this.introScreen.querySelector('h1');
                const introTextP = this.introScreen.querySelector('p');
                if (introTextH1) introTextH1.style.display = 'none';
                if (introTextP) introTextP.style.display = 'none';

                this.introVideo.muted = false;
                this.introVideo.loop = false;
                this.introVideo.currentTime = 0;

                this.introVideo.play().then(() => {
                    console.log("Intro video playing.");
                    this.introVideo.onended = () => {
                        console.log("Intro video ended.");
                        this.proceedToGameStart();
                    };
                }).catch(e => {
                    console.error("Error playing intro video:", e);
                    this.proceedToGameStart();
                });
            }

            proceedToGameStart() {
                if (!this.inIntro && this.gameActive) {
                    console.log("proceedToGameStart called but game already active or not in intro phase.");
                    return;
                }
                console.log("proceedToGameStart called");

                this.inIntro = false;
                this.introScreen.style.display = 'none';

                this.canvas.style.display = 'block';
                document.getElementById('joystick').style.display = 'flex';
                document.getElementById('fire-button').style.display = 'flex';
                document.getElementById('pause-button').style.display = 'flex';
                document.getElementById('show-leaderboard-button').style.display = 'flex';
                
                this.init();
                this.gameActive = true;
                this.lastTime = performance.now();

                this.bgMusic.currentTime = 0;
                this.bgMusic.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));

                requestAnimationFrame(this.gameLoop.bind(this));
                console.log("Game has started after intro video.");
            }

            startGame() {
                console.log("startGame function called (for restart)");

                if (this.waitForRestart) {
                    this.gameOverScreen.style.display = 'none';
                    this.gameActive = true;
                    this.lastTime = performance.now();

                    this.bgMusic.currentTime = 0;
                    this.bgMusic.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));
                    requestAnimationFrame(this.gameLoop.bind(this));
                    this.waitForRestart = false;
                    console.log("Game restarted.");
                } else {
                    console.log("startGame called but not in waitForRestart state.");
                }
            }

            gameLoop(timestamp) {
                if (!this.gameActive) {
                    if (this.waitForRestart) {
                         // Do nothing here, handleRestart will trigger init and startGame
                    }
                    return;
                }
                const deltaTime = (timestamp - this.lastTime) || 0;
                this.lastTime = timestamp;

                if (this.gamePaused) {
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.font = '30px Arial';
                    this.ctx.fillStyle = 'white';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('Ê∏∏ÊàèÊöÇÂÅú', this.canvas.width / 2, this.canvas.height / 2);
                    this.ctx.textAlign = 'left';
                    requestAnimationFrame(this.gameLoop.bind(this));
                    return;
                }

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                if (this.bgLoaded) {
                    this.ctx.drawImage(this.bgImage, 0, 0, 400, 600);
                } else {
                    this.ctx.fillStyle = 'black';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }

                this.drawPlayer();
                this.updateBullets();
                this.updateEnemies(deltaTime);
                this.updateEnemyBullets();
                this.drawInfoPanel();
                this.updateLaser(deltaTime);
                this.updatePlayerPosition();

                if (this.gameActive && Math.random() < this.spawnRate && this.enemies.length < this.maxEnemies) {
                    this.enemies.push({
                        x: Math.random() * (this.canvas.width - this.enemySize),
                        y: -this.enemySize
                    });
                }

                if (this.score >= this.nextLevelScore) {
                    this.levelUp();
                    this.nextLevelScore = this.nextLevelScore * 2;
                }

                requestAnimationFrame(this.gameLoop.bind(this));
            }

            handleRestart(e) {
                if (this.waitForRestart) {
                    e.preventDefault();
                    this.init();
                    this.startGame();
                }
            }

            //ÊëáÊùÜÊéßÂà∂
            setupTouchControls() {
                const joystick = document.getElementById('joystick');
                const joystickHandle = document.getElementById('joystick-handle');
                const fireButton = document.getElementById('fire-button');
                const pauseButton = document.getElementById('pause-button');
                let joystickBaseX, joystickBaseY;
                let joystickTouchId = null;
                let playerDirectionX = 0,
                    playerDirectionY = 0;

                joystick.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (joystickTouchId === null && e.touches[0]) {
                        joystickTouchId = e.touches[0].identifier;
                        joystickBaseX = e.touches[0].clientX - joystick.getBoundingClientRect().left;
                        joystickBaseY = e.touches[0].clientY - joystick.getBoundingClientRect().top;
                        joystickHandle.style.left = `${joystickBaseX - 25}px`;
                        joystickHandle.style.top = `${joystickBaseY - 25}px`;
                    }
                }, { passive: false });

                joystick.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (joystickTouchId !== null) {
                        const touch = Array.from(e.touches).find(t => t.identifier === joystickTouchId);
                        if (touch) {
                            const touchX = touch.clientX - joystick.getBoundingClientRect().left;
                            const touchY = touch.clientY - joystick.getBoundingClientRect().top;
                            const deltaX = touchX - joystickBaseX;
                            const deltaY = touchY - joystickBaseY;
                            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                            const maxDistance = joystick.offsetWidth / 2;
                            playerDirectionX = deltaX / maxDistance;
                            playerDirectionY = deltaY / maxDistance;
                            if (distance > maxDistance) {
                                playerDirectionX = deltaX / distance;
                                playerDirectionY = deltaY / distance;
                            }
                            joystickHandle.style.left = `${joystickBaseX + playerDirectionX * maxDistance - 25}px`;
                            joystickHandle.style.top = `${joystickBaseY + playerDirectionY * maxDistance - 25}px`;
                        }
                    }
                }, { passive: false });

                const resetJoystick = () => {
                    joystickTouchId = null;
                    playerDirectionX = 0;
                    playerDirectionY = 0;
                    joystickHandle.style.left = `${joystick.offsetWidth / 2 - joystickHandle.offsetWidth / 2}px`;
                    joystickHandle.style.top = `${joystick.offsetHeight / 2 - joystickHandle.offsetHeight / 2}px`;
                };

                joystick.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const relevantTouch = Array.from(e.changedTouches).find(t => t.identifier === joystickTouchId);
                    if (relevantTouch) {
                        resetJoystick();
                    }
                }, { passive: false });

                joystick.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    const relevantTouch = Array.from(e.changedTouches).find(t => t.identifier === joystickTouchId);
                    if (relevantTouch) {
                        resetJoystick();
                    }
                }, { passive: false });

                fireButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.fireBullet();
                });

                pauseButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.gamePaused = !this.gamePaused;
                    if (this.gamePaused) {
                        if (this.bgMusic) this.bgMusic.pause();
                    } else {
                        if (this.bgMusic) this.bgMusic.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));
                    }
                });

                this.updatePlayerPosition = () => {
                    const speed = 5;
                    this.playerPos.x += playerDirectionX * speed;
                    this.playerPos.y += playerDirectionY * speed;
                    this.playerPos.x = Math.max(0, Math.min(this.playerPos.x, 400 - this.playerSize));
                    this.playerPos.y = Math.max(0, Math.min(this.playerPos.y, 600 - this.playerSize * 1.2));
                };
            }

            //ÈîÆÁõòÊéßÂà∂
            setupKeyboardControls() {
                document.addEventListener('keydown', (e) => {
                    if (this.waitForRestart) {
                        return;
                    }
                    if (this.gamePaused && e.key !== 'p' && e.key !== 'P') {
                        return;
                    }

                    let moveSpeed = 15;
                    switch (e.key) {
                        case 'ArrowLeft':
                        case 'a':
                        case 'A':
                            this.playerPos.x = Math.max(0, this.playerPos.x - moveSpeed);
                            break;
                        case 'ArrowRight':
                        case 'd':
                        case 'D':
                            this.playerPos.x = Math.min(400 - this.playerSize, this.playerPos.x + moveSpeed);
                            break;
                        case 'ArrowUp':
                        case 'w':
                        case 'W':
                            this.playerPos.y = Math.max(0, this.playerPos.y - moveSpeed);
                            break;
                        case 'ArrowDown':
                        case 's':
                        case 'S':
                            this.playerPos.y = Math.min(600 - this.playerSize * 1.2, this.playerPos.y + moveSpeed);
                            break;
                        case ' ':
                            this.fireBullet();
                            break;
                        case 'p':
                        case 'P':
                            this.gamePaused = !this.gamePaused;
                            if (this.gamePaused) {
                                if (this.bgMusic) this.bgMusic.pause();
                            } else {
                                if (this.bgMusic) this.bgMusic.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));
                            }
                            break;
                    }
                });

                document.addEventListener('keydown', this.handleRestart.bind(this));
                document.addEventListener('mousedown', this.handleRestart.bind(this));
                document.addEventListener('touchstart', this.handleRestart.bind(this));
            }

            //Â∞ÑÂáª
            fireBullet() {
                if (this.characterLevel < this.maxCharacterLevel) {
                    this.bullets.push({
                        x: this.playerPos.x + this.playerSize / 2,
                        y: this.playerPos.y
                    });
                    this.playerShootSound.currentTime = 0;
                    this.playerShootSound.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));
                } else {
                    // ÊøÄÂÖâÊîªÂáª
                    this.laserActive = true;
                    this.laserTimer = 1.0;
                    this.playerShootSound.currentTime = 0;
                    this.playerShootSound.play().catch(e => console.log("Êí≠ÊîæÈü≥ÊïàÂ§±Ë¥•:", e));
                }
            }

            laserCollisionDetection() {
                if (this.laserActive) {
                    const laserWidth = 15;
                    const laserRect = {
                        x: this.playerPos.x + this.playerSize / 2 - laserWidth / 2,
                        y: 0,
                        width: laserWidth,
                        height: this.playerPos.y
                    };

                    // ÊøÄÂÖâÂè™ËÉΩÂáª‰∏≠Ë∑ØÂæÑ‰∏äÁöÑÊïå‰∫∫Ôºå‰∏çËÉΩÊ∏ÖÈô§Êïå‰∫∫Â≠êÂºπ
                    for (let i = this.enemies.length - 1; i >= 0; i--) {
                        const enemy = this.enemies[i];
                        const enemyRect = { x: enemy.x, y: enemy.y, width: this.enemySize, height: this.enemySize };
                        
                        if (this.checkCollision(laserRect, enemyRect)) {
                            this.destroyEnemy(i, enemy);
                        }
                    }
                }
            }

            /* LeaderBoard and Load Methods ************************************************************************************* */
            toggleLeaderboard() {
                this.leaderboardElement.style.display =
                    this.leaderboardElement.style.display === 'none' ? 'block' : 'none';
                if (this.leaderboardElement.style.display === 'block') {
                    this.updateLeaderboardDisplay();
                }
            }

            loadImages() {
                this.bgImage = new Image();
                this.bgImage.src = 'images/earth_view.jpg';
                this.bgImage.onload = () => this.bgLoaded = true;

                this.playerImage = new Image();
                this.playerImage.src = 'images/rayquaza.png';
                this.playerImage.onload = () => this.playerLoaded = true;

                this.enemyImage = new Image();
                this.enemyImage.src = 'images/deoxys.png';
                this.enemyImage.onload = () => this.enemyLoaded = true;
            }

            loadSounds() {
                this.bgMusic = new Audio('sounds/background_music.mp3');
                this.bgMusic.loop = true;

                this.playerShootSound = new Audio('sounds/player_shoot.mp3');
                this.enemyShootSound = new Audio('sounds/enemy_shoot.mp3');

                this.explosionSound = new Audio('sounds/explosion.mp3');

                this.levelUpSound = new Audio('sounds/level_up.mp3');
            }

            loadLeaderboard() {
                const data = localStorage.getItem('pokemonSpaceGameLeaderboard');
                return data ? JSON.parse(data) : [];
            }

            saveLeaderboard() {
                localStorage.setItem('pokemonSpaceGameLeaderboard', JSON.stringify(this.leaderboardData));
            }

            addScoreToLeaderboard(scoreEntry) {
                this.leaderboardData.push(scoreEntry);
                this.leaderboardData.sort((a, b) => b.score - a.score);
                this.leaderboardData = this.leaderboardData.slice(0, 10);
                this.saveLeaderboard();
                this.updateLeaderboardDisplay();
            }

            updateLeaderboardDisplay() {
                this.leaderboardList.innerHTML = '';
                if (this.leaderboardData.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'ÊöÇÊó†ËÆ∞ÂΩï';
                    this.leaderboardList.appendChild(li);
                } else {
                    this.leaderboardData.forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.textContent = `Á¨¨ ${index + 1} Âêç: ${entry.name} - ${entry.score} ÂàÜ`;
                        this.leaderboardList.appendChild(li);
                    });
                }
            }
        }

        // ÂΩìÈ°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂêØÂä®Ê∏∏Êàè
        window.onload = function() {
            new PokemonSpaceGame();
        };
    </script>
</body>

</html>

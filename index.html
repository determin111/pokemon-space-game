<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®å¯æ¢¦å¤ªç©ºå¯¹æˆ˜</title>
    <style>
        /*  ä¹‹å‰å®šä¹‰çš„cssæ ·å¼  */
        html, body {
            margin: 0;
            padding: 0;
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            font-family: Arial, sans-serif;
        }
        #gameCanvas {
            border: 1px solid #333;
            max-width: 100%;
            max-height: 100%;
        }
        .game-over {
            position: absolute;
            color: white;
            text-align: center;
            display: none;
        }
        .game-over h1 {
            color: red;
            font-size: 30px;
        }
        .game-over p {
            font-size: 20px;
            margin: 10px 0;
        }

        #joystick {
            position: absolute;
            bottom: 30px; /* è°ƒæ•´æ‘‡æ†çš„ä½ç½® */
            left: 30px;   /* è°ƒæ•´æ‘‡æ†çš„ä½ç½® */
            width: 100px;
            height: 100px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;  /* ä½¿å®ƒå˜æˆåœ†å½¢ */
            display: flex;
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
            align-items: center;    /* å‚ç›´å±…ä¸­ */
        }

        #joystick-handle {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;  /* ä½¿æ‰‹æŸ„å˜æˆåœ†å½¢ */
            position: absolute;
        }

         #fire-button {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            user-select: none; /* ç¦æ­¢æ–‡æœ¬é€‰æ‹© */
        }

        #pause-button {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 60px;
            height: 40px;
            background-color: rgba(0, 0, 255, 0.7);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 18px;
            user-select: none; /* ç¦æ­¢æ–‡æœ¬é€‰æ‹© */
        }

        /* æ’è¡Œæ¦œæ ·å¼ */
        #leaderboard {
            position: absolute;
            top: 80px; /* è°ƒæ•´ä½ç½®é¿å…ä¸æš‚åœæŒ‰é’®é‡å  */
            left: 30px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            display: none; /* åˆå§‹éšè— */
            z-index: 1000; /* ç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ */
            max-height: 200px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            overflow-y: auto; /* è¶…å‡ºé«˜åº¦æ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        }
        #leaderboard h2 {
            margin-top: 0;
            font-size: 20px;
        }
        #leaderboard ol {
            padding-left: 20px;
        }
        #leaderboard li {
            font-size: 16px;
            margin-bottom: 5px;
        }

        /* æ˜¾ç¤ºæ’è¡Œæ¦œæŒ‰é’® */
        #show-leaderboard-button { /* ä¿®æ”¹äº†ID */
            position: absolute;
            top: 30px;
            left: 30px; /* è°ƒæ•´åˆ°å·¦è¾¹ */
            width: 100px; /* å¢åŠ å®½åº¦ä»¥ä¾¿å®¹çº³æ–‡æœ¬ */
            height: 40px;
            background-color: rgba(0, 255, 0, 0.7);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: black;
            font-size: 14px;
            user-select: none;
            cursor: pointer;
        }
        
        /* å¤šäººè”æœºç•Œé¢ */
        #multiplayer-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: none;
            z-index: 2000;
            width: 80%;
            max-width: 400px;
        }
        
        #multiplayer-panel h2 {
            margin-top: 0;
            color: #00ff00;
            text-align: center;
        }
        
        #multiplayer-panel input, #multiplayer-panel button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: none;
        }
        
        #multiplayer-panel button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #multiplayer-panel button:hover {
            background-color: #45a049;
        }
        
        #player-list {
            margin-top: 15px;
            border-top: 1px solid #555;
            padding-top: 10px;
        }
        
        #player-list div {
            padding: 5px;
            margin: 5px 0;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        /* å¤šäººè”æœºæŒ‰é’® */
        #show-multiplayer-button {
            position: absolute;
            top: 30px;
            left: 140px; /* ä½äºæ’è¡Œæ¦œæŒ‰é’®å³ä¾§ */
            width: 100px;
            height: 40px;
            background-color: rgba(255, 165, 0, 0.7);
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: black;
            font-size: 14px;
            user-select: none;
            cursor: pointer;
        }
        
        /* ç©å®¶åç§°æ˜¾ç¤º */
        .player-name {
            position: absolute;
            color: white;
            font-size: 12px;
            text-align: center;
            text-shadow: 1px 1px 2px black;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <div class="game-over" id="gameOverScreen">
        <h1>æ¸¸æˆç»“æŸ</h1>
        <p id="finalScore">æœ€ç»ˆåˆ†æ•°: 0</p>
        <p>æŒ‰ä»»æ„é”®æˆ–ç‚¹å‡»å±å¹•é‡æ–°å¼€å§‹</p>
    </div>

    <!-- æ‘‡æ† -->
    <div id="joystick">
        <div id="joystick-handle"></div>
    </div>
     <!-- å°„å‡»æŒ‰é’® -->
    <div id="fire-button">ğŸ”¥</div>
     <!-- æš‚åœæŒ‰é’® -->
    <div id="pause-button">â¸ï¸</div>

    <!-- æ’è¡Œæ¦œ -->
    <div id="leaderboard">
        <h2>æ’è¡Œæ¦œ</h2>
        <ol id="leaderboard-list"></ol>
    </div>

    <!-- æ˜¾ç¤ºæ’è¡Œæ¦œæŒ‰é’® -->
    <div id="show-leaderboard-button">æŸ¥çœ‹æ’è¡Œæ¦œ</div>
    
    <!-- å¤šäººè”æœºæŒ‰é’® -->
    <div id="show-multiplayer-button">å¤šäººè”æœº</div>
    
    <!-- å¤šäººè”æœºé¢æ¿ -->
    <div id="multiplayer-panel">
        <h2>å¤šäººè”æœºæ¨¡å¼</h2>
        <input type="text" id="player-name" placeholder="è¾“å…¥ä½ çš„æ¸¸æˆåç§°">
        <button id="create-room-btn">åˆ›å»ºæˆ¿é—´</button>
        <button id="join-room-btn">åŠ å…¥æˆ¿é—´</button>
        <input type="text" id="room-id" placeholder="è¾“å…¥æˆ¿é—´ID" style="display:none">
        <button id="start-game-btn" style="display:none">å¼€å§‹æ¸¸æˆ</button>
        <button id="close-panel-btn">å…³é—­</button>
        
        <div id="player-list">
            <h3>åœ¨çº¿ç©å®¶</h3>
            <!-- ç©å®¶åˆ—è¡¨å°†åŠ¨æ€æ·»åŠ  -->
        </div>
    </div>

    <script>
        // æ¸¸æˆä¸»ç±»
        class PokemonSpaceGame {
            constructor() {
                // è·å–ç”»å¸ƒå’Œä¸Šä¸‹æ–‡
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gameOverScreen = document.getElementById('gameOverScreen');
                this.finalScoreText = document.getElementById('finalScore');

                // è·å–æ’è¡Œæ¦œç›¸å…³å…ƒç´ 
                this.leaderboardElement = document.getElementById('leaderboard');
                this.leaderboardList = document.getElementById('leaderboard-list');
                this.showLeaderboardButton = document.getElementById('show-leaderboard-button');
                
                // è·å–å¤šäººè”æœºç›¸å…³å…ƒç´ 
                this.multiplayerPanel = document.getElementById('multiplayer-panel');
                this.showMultiplayerButton = document.getElementById('show-multiplayer-button');
                this.playerNameInput = document.getElementById('player-name');
                this.createRoomBtn = document.getElementById('create-room-btn');
                this.joinRoomBtn = document.getElementById('join-room-btn');
                this.roomIdInput = document.getElementById('room-id');
                this.startGameBtn = document.getElementById('start-game-btn');
                this.closePanelBtn = document.getElementById('close-panel-btn');
                this.playerList = document.getElementById('player-list');

                // æ¸¸æˆçŠ¶æ€
                this.gameActive = true;
                this.gamePaused = false;
                this.waitForRestart = false;
                this.score = 0;

                this.lives = 7; // Adjusted starting lives
                this.level = 1;
                this.nextLevelScore = 25;  // Adjusted score needed to level up
                this.invulnerable = false; // Player invulnerability state
                this.invulnerableTimer = 0; // Timer for invulnerability

                //ã€æ–°å¢ã€‘è§’è‰²ç­‰çº§
                this.characterLevel = 1;
                this.maxCharacterLevel = 6; // æœ€é«˜è§’è‰²ç­‰çº§
                
                // ã€æ–°å¢ã€‘å¤šäººè”æœºç›¸å…³
                this.isMultiplayerMode = false;
                this.roomId = null;
                this.playerId = null;
                this.playerName = "";
                this.otherPlayers = {}; // å­˜å‚¨å…¶ä»–ç©å®¶ä¿¡æ¯
                this.isRoomOwner = false;

                // ç©å®¶ç›¸å…³å‚æ•°
                this.playerSize = 80;
                this.playerPos = {x: 160, y: 450};
                this.bullets = [];
                this.bulletSpeed = 9;  // Adjusted player bullet
                //ã€æ–°å¢ã€‘æ¿€å…‰ç›¸å…³å‚æ•°
                this.laserActive = false;
                this.laserTimer = 0;

                // æ•Œäººç›¸å…³å‚æ•° - Even further reduced difficulty
                this.enemies = [];
                this.enemySize = 50;
                this.enemySpeed = 1.2; // Adjusted enemy speed
                this.spawnRate = 0.012; // Adjusted spawn rate
                this.maxEnemies = 4;   // Adjusted max enemies
                this.enemyFireRate = 0.006; // Adjusted enemy fire rate
                this.enemyBullets = [];
                this.enemyBulletSpeed = 2.7; // Adjusted enemy bullet speed
                this.enemyBulletSize = 8;

                // ã€æ–°å¢ã€‘æ’è¡Œæ¦œæ•°æ®
                this.leaderboardData = this.loadLeaderboard();
                
                // ã€æ–°å¢ã€‘æ•Œäººç­‰çº§ç›¸å…³
                this.enemyLevels = {};  // å­˜å‚¨æ•Œäººç­‰çº§ {enemyId: level}

                // åŠ è½½å›¾åƒ
                this.loadImages();

                // åŠ è½½éŸ³æ•ˆ
                this.loadSounds();

                // è®¾ç½®é”®ç›˜äº‹ä»¶ç›‘å¬
                this.setupKeyboardControls();

                // è®¾ç½®è§¦æ‘¸æ§åˆ¶
                this.setupTouchControls();
                
                // è®¾ç½®å¤šäººè”æœºæ§åˆ¶
                this.setupMultiplayerControls();

                 // æ·»åŠ ç‚¹å‡»å±å¹•é‡æ–°å¼€å§‹çš„äº‹ä»¶ç›‘å¬å™¨
                document.addEventListener('mousedown', this.handleRestart.bind(this));  //é¼ æ ‡ç‚¹å‡»
                document.addEventListener('touchstart', this.handleRestart.bind(this)); //è§¦æ‘¸

                // æ˜¾ç¤º/éšè— æ’è¡Œæ¦œ
                this.showLeaderboardButton.addEventListener('click', () => {
                    this.leaderboardElement.style.display = this.leaderboardElement.style.display === 'none' ? 'block' : 'none';
                    if (this.leaderboardElement.style.display === 'block') {
                        this.updateLeaderboardDisplay();
                    }
                });
                
                // æ˜¾ç¤º/éšè— å¤šäººè”æœºé¢æ¿
                this.showMultiplayerButton.addEventListener('click', () => {
                    this.multiplayerPanel.style.display = 'block';
                    this.gamePaused = true;
                });

                // å¼€å§‹æ¸¸æˆå¾ªç¯
                this.lastTime = 0;
                this.init();
                setInterval(() => {
                    if (this.gameActive && !this.gamePaused) {
                        this.updatePlayerPosition();
                        
                        // å¤šäººæ¨¡å¼ä¸‹ï¼ŒåŒæ­¥ç©å®¶ä½ç½®
                        if (this.isMultiplayerMode) {
                            this.syncPlayerPosition();
                        }
                    }
                }, 20); // æ¯ 20 æ¯«ç§’
            }

            loadImages() {
                // èƒŒæ™¯å›¾åƒ
                this.bgImage = new Image();
                this.bgImage.src = 'images/earth_view.jpg';
                this.bgImage.onload = () => this.bgLoaded = true;

                // ç©å®¶å›¾åƒ
                this.playerImage = new Image();
                this.playerImage.src = 'images/rayquaza.png';
                this.playerImage.onload = () => this.playerLoaded = true;

                // æ•Œäººå›¾åƒ
                this.enemyImage = new Image();
                this.enemyImage.src = 'images/deoxys.png';
                this.enemyImage.onload = () => this.enemyLoaded = true;
            }

            loadSounds() {
                // èƒŒæ™¯éŸ³ä¹
                this.bgMusic = new Audio('sounds/background_music.mp3');
                this.bgMusic.loop = true;

                // å°„å‡»éŸ³æ•ˆ
                this.playerShootSound = new Audio('sounds/player_shoot.mp3');
                this.enemyShootSound = new Audio('sounds/enemy_shoot.mp3');

                // çˆ†ç‚¸éŸ³æ•ˆ
                this.explosionSound = new Audio('sounds/explosion.mp3');

                // å‡çº§éŸ³æ•ˆ
                this.levelUpSound = new Audio('sounds/level_up.mp3');
            }

            setupKeyboardControls() {
                document.addEventListener('keydown', (e) => {
                    // å¤„ç†æ¸¸æˆç»“æŸåçš„é‡æ–°å¼€å§‹
                    if (this.waitForRestart) {
                        this.init();
                        return;
                    }

                    // å¤„ç†æ¸¸æˆæš‚åœçŠ¶æ€ä¸‹çš„æŒ‰é”®
                    if (this.gamePaused && e.key !== 'p') {
                        return;
                    }

                    let moveSpeed = 15;
                    switch (e.key) {
                        case 'ArrowLeft':
                            this.playerPos.x = Math.max(0, this.playerPos.x - moveSpeed);
                            break;
                        case 'ArrowRight':
                            this.playerPos.x = Math.min(400 - this.playerSize, this.playerPos.x + moveSpeed);
                            break;
                        case 'ArrowUp':
                            this.playerPos.y = Math.max(0, this.playerPos.y - moveSpeed);
                            break;
                        case 'ArrowDown':
                            this.playerPos.y = Math.min(600 - this.playerSize * 1.2, this.playerPos.y + moveSpeed);
                            break;
                        case ' ': // ç©ºæ ¼é”®
                            this.fireBullet();
                            break;
                        case 'p':
                            this.gamePaused = !this.gamePaused;

                            // å¤„ç†èƒŒæ™¯éŸ³ä¹
                            if (this.gamePaused) {
                                this.bgMusic.pause();
                            } else {
                                this.bgMusic.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));
                            }
                            break;
                    }
                });
            }

            handleRestart(e) {
                if (this.waitForRestart) {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                    this.init(); // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
                }
            }

            setupTouchControls() {
                const joystick = document.getElementById('joystick');
                const joystickHandle = document.getElementById('joystick-handle');
                const fireButton = document.getElementById('fire-button');
                const pauseButton = document.getElementById('pause-button');
                let joystickBaseX, joystickBaseY;
                let joystickTouchId = null;  // ç”¨äºè·Ÿè¸ªè§¦æ‘¸ID
                let playerDirectionX = 0, playerDirectionY = 0; // ç©å®¶ç§»åŠ¨æ–¹å‘

                // æ£€æŸ¥è§¦æ‘¸æ˜¯å¦åœ¨æŒ‡å®šèŒƒå›´å†…
                const isInZone = (x, y, zone) => {
                    return x >= zone.x && x <= zone.x + zone.width &&
                        y >= zone.y && y <= zone.y + zone.height;
                };

                joystick.addEventListener('touchstart', (e) => {
                    e.preventDefault();

                    if (joystickTouchId === null && e.touches[0]) { // åªå¤„ç†ç¬¬ä¸€ä¸ªè§¦æ‘¸
                        joystickTouchId = e.touches[0].identifier;

                        joystickBaseX = e.touches[0].clientX - joystick.getBoundingClientRect().left;
                        joystickBaseY = e.touches[0].clientY - joystick.getBoundingClientRect().top;
                        // è°ƒæ•´æ‰‹æŸ„ä½ç½®
                        joystickHandle.style.left = `${joystickBaseX - 25}px`; // ä½¿æ‰‹æŸ„å±…ä¸­
                        joystickHandle.style.top = `${joystickBaseY - 25}px`; // ä½¿æ‰‹æŸ„å±…ä¸­
                    }
                }, { passive: false });

                joystick.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (joystickTouchId !== null) {
                        const touch = Array.from(e.touches).find(t => t.identifier === joystickTouchId);
                        if (touch) {
                            const touchX = touch.clientX - joystick.getBoundingClientRect().left;
                            const touchY = touch.clientY - joystick.getBoundingClientRect().top;
                            // è®¡ç®—è§¦æ‘¸ç‚¹è·æ‘‡æ†ä¸­å¿ƒç‚¹çš„åç§»
                            const deltaX = touchX - joystickBaseX;
                            const deltaY = touchY - joystickBaseY;

                            // è®¡ç®—è§¦æ‘¸ç‚¹è·ç¦»ä¸­å¿ƒç‚¹çš„è·ç¦»
                            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                            const maxDistance = joystick.offsetWidth / 2;                // è®¡ç®—æ–¹å‘ï¼Œå½’ä¸€åŒ–å‘é‡
                            playerDirectionX = deltaX / maxDistance;
                            playerDirectionY = deltaY / maxDistance;
                            // é™å®šæœ€å¤§è·ç¦»
                            if (distance > maxDistance) {
                                playerDirectionX = deltaX / distance;
                                playerDirectionY = deltaY / distance;
                            }

                            // æ›´æ–°æ‰‹æŸ„ä½ç½®
                            joystickHandle.style.left = `${joystickBaseX + playerDirectionX * maxDistance - 25}px`;
                            joystickHandle.style.top = `${joystickBaseY + playerDirectionY * maxDistance - 25}px`;
                        }
                    }
                }, { passive: false });

                joystick.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const relevantTouch = Array.from(e.changedTouches).find(t => t.identifier === joystickTouchId);
                    if (relevantTouch) {
                        joystickTouchId = null;
                        playerDirectionX = 0;
                        playerDirectionY = 0;

                        // å¤ä½æ‰‹æŸ„ä½ç½®
                        joystickHandle.style.left = `${joystick.offsetWidth / 2 - joystickHandle.offsetWidth / 2}px`;
                        joystickHandle.style.top = `${joystick.offsetHeight / 2 - joystickHandle.offsetHeight / 2}px`;
                    }
                }, { passive: false });


                joystick.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                     const relevantTouch = Array.from(e.changedTouches).find(t => t.identifier === joystickTouchId);
                    if (relevantTouch) {
                        joystickTouchId = null;
                        playerDirectionX = 0;
                        playerDirectionY = 0;
                        // å¤ä½æ‰‹æŸ„ä½ç½®
                        joystickHandle.style.left = `${joystick.offsetWidth / 2 - joystickHandle.offsetWidth / 2}px`;
                        joystickHandle.style.top = `${joystick.offsetHeight / 2 - joystickHandle.offsetHeight / 2}px`;
                    }
                }, { passive: false });

                // å°„å‡»æŒ‰é’®äº‹ä»¶
                fireButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.fireBullet();

                });

                // æš‚åœæŒ‰é’®äº‹ä»¶
                pauseButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.gamePaused = !this.gamePaused;

                    // å¤„ç†èƒŒæ™¯éŸ³ä¹
                    if (this.gamePaused) {
                        this.bgMusic.pause();
                    } else {
                        this.bgMusic.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));
                    }
                });
                // æ›´æ–°ç©å®¶ç§»åŠ¨
                this.updatePlayerPosition = () => {
                    const speed = 5; // è°ƒæ•´é€Ÿåº¦
                    this.playerPos.x += playerDirectionX * speed;
                    this.playerPos.y += playerDirectionY * speed;
                    // è¾¹ç•Œæ£€æŸ¥
                    this.playerPos.x = Math.max(0, Math.min(this.playerPos.x, 400 - this.playerSize));
                    this.playerPos.y = Math.max(0, Math.min(this.playerPos.y, 600 - this.playerSize * 1.2));
                };
            }
            
            setupMultiplayerControls() {
                // åˆ›å»ºæˆ¿é—´æŒ‰é’®äº‹ä»¶
                this.createRoomBtn.addEventListener('click', () => {
                    if (!this.playerNameInput.value.trim()) {
                        alert('è¯·è¾“å…¥ç©å®¶åç§°');
                        return;
                    }
                    
                    this.playerName = this.playerNameInput.value.trim();
                    this.roomId = this.generateRoomId();
                    this.playerId = this.generatePlayerId();
                    this.isRoomOwner = true;
                    
                    // æ˜¾ç¤ºæˆ¿é—´IDå’Œå¼€å§‹æ¸¸æˆæŒ‰é’®
                    alert(`æˆ¿é—´åˆ›å»ºæˆåŠŸ! æˆ¿é—´ID: ${this.roomId}`);
                    this.startGameBtn.style.display = 'block';
                    
                    // åœ¨è¿™é‡Œåº”è¯¥è¿›è¡Œå®é™…çš„ç½‘ç»œè¿æ¥ï¼Œè¿™é‡Œä»…æ¨¡æ‹Ÿ
                    this.simulateMultiplayerConnection();
                });
                
                // åŠ å…¥æˆ¿é—´æŒ‰é’®äº‹ä»¶
                this.joinRoomBtn.addEventListener('click', () => {
                    if (!this.playerNameInput.value.trim()) {
                        alert('è¯·è¾“å…¥ç©å®¶åç§°');
                        return;
                    }
                    
                    this.roomIdInput.style.display = 'block';
                    this.createRoomBtn.style.display = 'none';
                    this.joinRoomBtn.textContent = 'ç¡®è®¤åŠ å…¥';
                    
                    // å¦‚æœå·²ç»æ˜¾ç¤ºäº†æˆ¿é—´IDè¾“å…¥æ¡†ï¼Œåˆ™å°è¯•åŠ å…¥æˆ¿é—´
                    if (this.roomIdInput.style.display === 'block' && this.roomIdInput.value.trim()) {
                        this.playerName = this.playerNameInput.value.trim();
                        this.roomId = this.roomIdInput.value.trim();
                        this.playerId = this.generatePlayerId();
                        this.isRoomOwner = false;
                        
                        // åœ¨è¿™é‡Œåº”è¯¥è¿›è¡Œå®é™…çš„ç½‘ç»œè¿æ¥ï¼Œè¿™é‡Œä»…æ¨¡æ‹Ÿ
                        this.simulateMultiplayerConnection();
                    }
                });
                
                // å¼€å§‹æ¸¸æˆæŒ‰é’®äº‹ä»¶
                this.startGameBtn.addEventListener('click', () => {
                    if (this.isRoomOwner) {
                        this.startMultiplayerGame();
                    }
                });
                
                // å…³é—­é¢æ¿æŒ‰é’®äº‹ä»¶
                this.closePanelBtn.addEventListener('click', () => {
                    this.multiplayerPanel.style.display = 'none';
                    this.gamePaused = false;
                    
                    // é‡ç½®å¤šäººè”æœºé¢æ¿
                    this.roomIdInput.style.display = 'none';
                    this.createRoomBtn.style.display = 'block';
                    this.joinRoomBtn.textContent = 'åŠ å…¥æˆ¿é—´';
                });
            }
            
            // ç”Ÿæˆéšæœºæˆ¿é—´ID
            generateRoomId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            // ç”Ÿæˆéšæœºç©å®¶ID
            generatePlayerId() {
                return Math.random().toString(36).substring(2, 10);
            }
            
            // æ¨¡æ‹Ÿå¤šäººè”æœºè¿æ¥
            simulateMultiplayerConnection() {
                // æ¸…ç©ºç©å®¶åˆ—è¡¨
                while (this.playerList.children.length > 1) {
                    this.playerList.removeChild(this.playerList.lastChild);
                }
                
                // æ·»åŠ è‡ªå·±
                const playerDiv = document.createElement('div');
                playerDiv.textContent = `${this.playerName} (ä½ )`;
                this.playerList.appendChild(playerDiv);
                
                // æ¨¡æ‹Ÿæ·»åŠ å…¶ä»–ç©å®¶
                if (this.isRoomOwner) {
                    // æ¨¡æ‹Ÿ2-3ä¸ªå…¶ä»–ç©å®¶åŠ å…¥
                    const otherPlayersCount = Math.floor(Math.random() * 2) + 2;
                    const names = ['å°æ™º', 'å°èŒ‚', 'å°éœ', 'å°åˆš', 'å°é¥'];
                    
                    for (let i = 0; i < otherPlayersCount; i++) {
                        const randomName = names[Math.floor(Math.random() * names.length)];
                        const otherId = this.generatePlayerId();
                        
                        const otherPlayerDiv = document.createElement('div');
                        otherPlayerDiv.textContent = randomName;
                        this.playerList.appendChild(otherPlayerDiv);
                        
                        // è®°å½•å…¶ä»–ç©å®¶
                        this.otherPlayers[otherId] = {
                            name: randomName,
                            x: Math.random() * (400 - this.playerSize),
                            y: Math.random() * (400 - this.playerSize) + 100,
                            score: 0
                        };
                    }
                }
            }
            
            // å¼€å§‹å¤šäººæ¸¸æˆ
            startMultiplayerGame() {
                this.isMultiplayerMode = true;
                this.multiplayerPanel.style.display = 'none';
                this.gamePaused = false;
                
                // åˆå§‹åŒ–æ¸¸æˆ
                this.init();
                
                // å‘æ‰€æœ‰ç©å®¶å¹¿æ’­æ¸¸æˆå¼€å§‹çš„æ¶ˆæ¯
                console.log("å¤šäººæ¸¸æˆå¼€å§‹!");
            }
            
            // åŒæ­¥ç©å®¶ä½ç½®ï¼ˆå¤šäººæ¨¡å¼ï¼‰
            syncPlayerPosition() {
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å‘é€ç½‘ç»œè¯·æ±‚æ›´æ–°ç©å®¶ä½ç½®
                // è¿™é‡Œä»…åšæ¨¡æ‹Ÿï¼Œè®©å…¶ä»–ç©å®¶éšæœºç§»åŠ¨
                if (Math.random() < 0.05) {  // 5%æ¦‚ç‡æ›´æ–°ä½ç½®
                    Object.keys(this.otherPlayers).forEach(id => {
                        const player = this.otherPlayers[id];
                        
                        // éšæœºç§»åŠ¨
                        player.x += (Math.random() - 0.5) * 10;
                        player.y += (Math.random() - 0.5) * 10;
                        
                        // è¾¹ç•Œæ£€æŸ¥
                        player.x = Math.max(0, Math.min(player.x, 400 - this.playerSize));
                        player.y = Math.max(0, Math.min(player.y, 600 - this.playerSize * 1.2));
                    });
                }
            }

            fireBullet() {
                //ã€ä¿®æ”¹ã€‘æ ¹æ®è§’è‰²ç­‰çº§åˆ¤æ–­å‘å°„ç±»å‹
                if (this.characterLevel < this.maxCharacterLevel) { // ç­‰çº§å°äº6å‘å°„å­å¼¹
                    // ä»megaè£‚ç©ºåº§çš„å£éƒ¨ä½ç½®å‘å°„å­å¼¹
                    this.bullets.push({
                        x: this.playerPos.x + this.playerSize / 2,
                        y: this.playerPos.y, // å­å¼¹ä»è§’è‰²é¡¶éƒ¨å‘å°„
                        playerId: this.playerId // è®°å½•å‘å°„å­å¼¹çš„ç©å®¶ID
                    });

                    // æ’­æ”¾å°„å‡»éŸ³æ•ˆ
                    this.playerShootSound.currentTime = 0;
                    this.playerShootSound.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));
                } else { // ç­‰çº§è¾¾åˆ°6å‘å°„æ¿€å…‰
                    // æ¿€æ´»æ¿€å…‰
                    this.laserActive = true;
                    this.laserTimer = 0.5; // æ¿€å…‰æŒç»­0.5ç§’
                    this.playerShootSound.currentTime = 0;
                    this.playerShootSound.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));
                }
            }

            init() {
                this.spawnRate = 0.012;
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                this.gameActive = true;
                this.gamePaused = false;
                this.waitForRestart = false;
                this.playerPos = {x: 160, y: 450};
                this.bullets = [];
                this.enemies = [];
                this.enemyBullets = [];
                this.score = 0;
                this.lives = 7; // åˆå§‹ç”Ÿå‘½å€¼
                this.level = 1;
                this.nextLevelScore = 25;
                this.enemySpeed = 1.2;
                this.enemyFireRate = 0.006;
                this.maxEnemies = 4;
                this.invulnerable = false;  // Reset invulnerability on game start
                this.invulnerableTimer = 0;
                //ã€æ–°å¢ã€‘é‡ç½®è§’è‰²ç­‰çº§
                this.characterLevel = 1;
                this.laserActive = false;
                this.laserTimer = 0;
                // ã€æ–°å¢ã€‘é‡ç½®æ•Œäººç­‰çº§
                this.enemyLevels = {};

                // éšè—æ¸¸æˆç»“æŸå±å¹•
                this.gameOverScreen.style.display = 'none';
                // éšè—æ’è¡Œæ¦œ
                this.leaderboardElement.style.display = 'none';

                // å¼€å§‹èƒŒæ™¯éŸ³ä¹
                this.bgMusic.currentTime = 0;
                this.bgMusic.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));

                // å¼€å§‹æ¸¸æˆå¾ªç¯
                requestAnimationFrame(this.gameLoop.bind(this));
            }

            gameLoop(timestamp) {
                if (!this.gameActive) return;

                const deltaTime = (timestamp - this.lastTime) || 0; // Handle first frame
                this.lastTime = timestamp;

                if (this.gamePaused) {
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.font = '30px Arial';
                    this.ctx.fillStyle = 'white';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('æ¸¸æˆæš‚åœ', this.canvas.width / 2, this.canvas.height / 2);
                    this.ctx.textAlign = 'left';
                    requestAnimationFrame(this.gameLoop.bind(this));
                    return;
                }

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                if (this.bgLoaded) {
                    this.ctx.drawImage(this.bgImage, 0, 0, 400, 600);
                } else {
                    this.ctx.fillStyle = 'black';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }

                   // Generate new enemies (with the maximum limit check)
                   if (Math.random() < this.spawnRate && this.enemies.length < this.maxEnemies) {
                    const x = Math.random() * (400 - this.enemySize);
                    const enemyId = Date.now() + Math.random(); // ç”Ÿæˆå”¯ä¸€ID
                    const enemyLevel = this.determineEnemyLevel(); // ç¡®å®šæ•Œäººç­‰çº§
                    
                    this.enemies.push({ 
                        id: enemyId,
                        x: x, 
                        y: 0,
                        level: enemyLevel 
                    });
                    
                    // è®°å½•æ•Œäººç­‰çº§
                    this.enemyLevels[enemyId] = enemyLevel;
                   }

                this.drawPlayer();
                
                // å¤šäººæ¨¡å¼ä¸‹ç»˜åˆ¶å…¶ä»–ç©å®¶
                if (this.isMultiplayerMode) {
                    this.drawOtherPlayers();
                }
                
                this.updateBullets();
                this.updateEnemies(deltaTime);
                this.updateEnemyBullets();
                this.drawInfoPanel();
                //ã€æ–°å¢ã€‘æ›´æ–°æ¿€å…‰çŠ¶æ€
                this.updateLaser(deltaTime);

                  if (this.score >= this.nextLevelScore) {
                    this.levelUp();
                    this.nextLevelScore = this.nextLevelScore * 2;
                  }

                requestAnimationFrame(this.gameLoop.bind(this));
            }
            
            // ç¡®å®šæ•Œäººç­‰çº§
            determineEnemyLevel() {
                // åŸºäºæ¸¸æˆéš¾åº¦å’Œéšæœºæ€§ç¡®å®šæ•Œäººç­‰çº§
                const baseLevel = Math.min(10, Math.floor(this.level / 2) + 1);
                
                // æœ‰å°æ¦‚ç‡ç”Ÿæˆé«˜ç­‰çº§æ•Œäºº
                if (Math.random() < 0.1) {
                    return Math.min(10, baseLevel + Math.floor(Math.random() * 3) + 1);
                }
                
                return baseLevel;
            }
            
            // ç»˜åˆ¶å…¶ä»–ç©å®¶
            drawOtherPlayers() {
                Object.keys(this.otherPlayers).forEach(id => {
                    const player = this.otherPlayers[id];
                    
                    // ç»˜åˆ¶ç©å®¶
                    if (this.playerLoaded) {
                        this.ctx.drawImage(this.playerImage, player.x, player.y, this.playerSize, this.playerSize);
                    } else {
                        this.ctx.fillStyle = 'blue'; // å…¶ä»–ç©å®¶ç”¨è“è‰²åŒºåˆ†
                        this.ctx.fillRect(player.x, player.y, this.playerSize, this.playerSize);
                    }
                    
                    // ç»˜åˆ¶ç©å®¶åç§°
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(player.name, player.x + this.playerSize / 2, player.y - 5);
                    this.ctx.textAlign = 'left';
                });
            }

             drawPlayer() {
                if (this.playerLoaded) {
                    //  Flicker the player image if invulnerable
                        if (this.invulnerable && Math.floor(Date.now() / 100) % 2) { // Blink effect
                            return; // Skip drawing for flicker effect
                        }
                   this.ctx.drawImage(this.playerImage, this.playerPos.x, this.playerPos.y, this.playerSize, this.playerSize);
                } else {
                    this.ctx.fillStyle = 'green';
                    if (this.invulnerable && Math.floor(Date.now() / 100) % 2) { // Blink effect
                         return; // Skip drawing for flicker effect
                    }
                    this.ctx.fillRect(this.playerPos.x, this.playerPos.y, this.playerSize, this.playerSize);
                }
                
                // å¤šäººæ¨¡å¼ä¸‹æ˜¾ç¤ºç©å®¶åç§°
                if (this.isMultiplayerMode) {
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(this.playerName + " (ä½ )", this.playerPos.x + this.playerSize / 2, this.playerPos.y - 5);
                    this.ctx.textAlign = 'left';
                }
            }

            updateBullets() {
                //ã€ä¿®æ”¹ã€‘åªæœ‰å½“è§’è‰²ç­‰çº§å°äºmaxCharacterLevelæ—¶æ‰æ›´æ–°å­å¼¹
                if(this.characterLevel < this.maxCharacterLevel){
                    for (let i = this.bullets.length - 1; i >= 0; i--) {
                        this.bullets[i].y -= this.bulletSpeed;
                        if (this.bullets[i].y < -20) { // å­å¼¹è¶…å‡ºå±å¹•ä¸€å®šè·ç¦»åç§»é™¤
                            this.bullets.splice(i, 1);
                            continue;
                        }

                        const bullet = this.bullets[i];
                        const bulletWidth = 5;
                        const bulletHeight = 20;

                        this.ctx.fillStyle = 'red'; // çº¢è‰²å­å¼¹
                        this.ctx.fillRect(bullet.x - bulletWidth / 2, bullet.y, bulletWidth, bulletHeight);

                        for (let j = this.enemies.length - 1; j >= 0; j--) {
                            const enemy = this.enemies[j];
                            if (this.checkCollision(
                                { x: bullet.x - bulletWidth / 2, y: bullet.y, width: bulletWidth, height: bulletHeight },
                                { x: enemy.x, y: enemy.y, width: this.enemySize, height: this.enemySize }
                            )) {
                                this.enemies.splice(j, 1);
                                this.score += 5;
                                this.drawExplosion(enemy.x + this.enemySize / 2, enemy.y + this.enemySize / 2, this.enemySize);
                                this.explosionSound.currentTime = 0;
                                this.explosionSound.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));
                                this.bullets.splice(i, 1);
                                
                                // å¤šäººæ¨¡å¼ä¸‹æ›´æ–°åˆ†æ•°
                                if (this.isMultiplayerMode && bullet.playerId) {
                                    // å¦‚æœæ˜¯è‡ªå·±å‘å°„çš„å­å¼¹
                                    if (bullet.playerId === this.playerId) {
                                        // åˆ†æ•°å·²ç»åœ¨ä¸Šé¢æ›´æ–°è¿‡äº†
                                    } else if (this.otherPlayers[bullet.playerId]) {
                                        // å¦‚æœæ˜¯å…¶ä»–ç©å®¶å‘å°„çš„å­å¼¹
                                        this.otherPlayers[bullet.playerId].score += 5;
                                    }
                                }
                                
                                break; // å­å¼¹å·²å‡»ä¸­æ•Œäººï¼Œä¸å†æ£€æŸ¥å…¶ä»–æ•Œäºº
                            }
                        }
                    }
                }
            }

            updateLaser(deltaTime) {
                if (this.laserActive) {
                    this.drawLaser();
                    this.laserTimer -= deltaTime / 1000;
                    if (this.laserTimer <= 0) {
                        this.laserActive = false;
                        this.laserTimer = 0;
                    }
                    this.laserCollisionDetection();
                }
            }

            drawLaser() {
                // æ¿€å…‰ä»è§’è‰²ä¸­å¿ƒå‘ä¸Šå‘å°„ï¼Œè¦†ç›–æ•´ä¸ªç”»å¸ƒå®½åº¦
                this.ctx.fillStyle = 'rgba(255, 0, 0, 0.7)'; // çº¢è‰²æ¿€å…‰
                // æ¿€å…‰å®½åº¦å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ï¼Œè¿™é‡Œå‡è®¾ä¸º10px
                const laserWidth = 10;
                this.ctx.fillRect(this.playerPos.x + this.playerSize / 2 - laserWidth / 2, 0, laserWidth, this.playerPos.y);
            }

            laserCollisionDetection() {
                // æ¿€å…‰çš„ç¢°æ’åŒºåŸŸæ˜¯ä¸€ä¸ªä»ç©å®¶ä½ç½®å‘ä¸Šå»¶ä¼¸åˆ°å±å¹•é¡¶éƒ¨çš„çŸ©å½¢
                const laserWidth = 10; // ä¸drawLaserä¸­çš„å®½åº¦ä¸€è‡´
                const laserRect = {
                    x: this.playerPos.x + this.playerSize / 2 - laserWidth / 2,
                    y: 0,
                    width: laserWidth,
                    height: this.playerPos.y
                };

                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    const enemyRect = { x: enemy.x, y: enemy.y, width: this.enemySize, height: this.enemySize };
                    if (this.checkCollision(laserRect, enemyRect)) {
                        this.enemies.splice(i, 1);
                        this.score += 5;
                        this.drawExplosion(enemy.x + this.enemySize / 2, enemy.y + this.enemySize / 2, this.enemySize);
                        this.explosionSound.currentTime = 0;
                        this.explosionSound.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));
                    }
                }
            }

            updateEnemies(deltaTime) {
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    const enemyRect = { x: enemy.x, y: enemy.y, width: this.enemySize, height: this.enemySize };
                    const playerRect = { x: this.playerPos.x, y: this.playerPos.y, width: this.playerSize, height: this.playerSize };

                    if (!this.invulnerable && this.checkCollision(playerRect, enemyRect)) {
                        this.drawExplosion(
                            this.playerPos.x + this.playerSize / 2,
                            this.playerPos.y + this.playerSize / 2,
                            this.playerSize / 2
                        );
                        this.explosionSound.currentTime = 0;
                        this.explosionSound.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));

                        this.lives--;
                        this.enemies.splice(i, 1);

                        if (this.lives <= 0) {
                            this.gameOver();
                            return;
                        }

                        this.invulnerable = true;
                        this.invulnerableTimer = 2;
                    } else {
                        enemy.y += this.enemySpeed;
                        if (enemy.y > this.canvas.height) {
                            this.enemies.splice(i, 1);
                        }
                    }

                    // ç»˜åˆ¶æ•Œäººç­‰çº§
                    const enemyLevel = enemy.level || 1;
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '10px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(`Lv${enemyLevel}`, enemy.x + this.enemySize / 2, enemy.y - 5);
                    this.ctx.textAlign = 'left';

                    if (this.enemyLoaded) {
                        this.ctx.drawImage(this.enemyImage, enemy.x, enemy.y, this.enemySize, this.enemySize);
                    } else {
                        this.ctx.fillStyle = 'red';
                        this.ctx.fillRect(enemy.x, enemy.y, this.enemySize, this.enemySize);
                    }

                    // æ•Œäººå‘å°„å­å¼¹
                    if (Math.random() < this.enemyFireRate && this.gameActive) { // ç¡®ä¿æ¸¸æˆæ¿€æ´»çŠ¶æ€æ‰å‘å°„
                        // æ ¹æ®æ•Œäººç­‰çº§ç¡®å®šå‘å°„ç±»å‹
                        const enemyLevel = enemy.level || 1;
                        
                        if (enemyLevel >= 10) {
                            // 10çº§åŠä»¥ä¸Šæ•Œäººå‘å°„æ•£å¼¹
                            this.fireEnemyShotgun(enemy);
                        } else {
                            // æ™®é€šæ•Œäººå‘å°„å•é¢—å­å¼¹
                            this.enemyBullets.push({
                                x: enemy.x + this.enemySize / 2,
                                y: enemy.y + this.enemySize
                            });
                        }
                        
                        this.enemyShootSound.currentTime = 0;
                        this.enemyShootSound.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));
                    }
                }

                if (this.invulnerable) {
                    this.invulnerableTimer -= deltaTime / 1000;
                    if (this.invulnerableTimer <= 0) {
                        this.invulnerable = false;
                        this.invulnerableTimer = 0;
                    }
                }
            }
            
            // æ•Œäººå‘å°„æ•£å¼¹
            fireEnemyShotgun(enemy) {
                // å‘å°„ä¸‰ä¸ªæ–¹å‘çš„å­å¼¹
                for (let i = -1; i <= 1; i++) {
                    this.enemyBullets.push({
                        x: enemy.x + this.enemySize / 2,
                        y: enemy.y + this.enemySize,
                        speedX: i * 1.5, // æ°´å¹³é€Ÿåº¦åˆ†é‡
                        shotgun: true // æ ‡è®°ä¸ºæ•£å¼¹
                    });
                }
            }

            updateEnemyBullets() {
                for (let i = this.enemyBullets.length - 1; i >= 0; i--) {
                    const bullet = this.enemyBullets[i];
                    
                    // æ•£å¼¹æœ‰æ°´å¹³é€Ÿåº¦åˆ†é‡
                    if (bullet.shotgun) {
                        bullet.x += bullet.speedX || 0;
                    }
                    
                    bullet.y += this.enemyBulletSpeed;

                    if (bullet.y > this.canvas.height || bullet.x < 0 || bullet.x > this.canvas.width) {
                        this.enemyBullets.splice(i, 1);
                        continue;
                    }

                    const ballSize = this.enemyBulletSize;
                    
                    // æ•£å¼¹ç»˜åˆ¶ä¸ºç´«è‰²
                    if (bullet.shotgun) {
                        this.ctx.fillStyle = 'rgba(128, 0, 255, 0.3)';
                        this.ctx.beginPath();
                        this.ctx.arc(bullet.x, bullet.y, ballSize * 1.8, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        this.ctx.fillStyle = 'rgba(128, 0, 255, 1)';
                    } else {
                        this.ctx.fillStyle = 'rgba(255, 77, 255, 0.3)';
                        this.ctx.beginPath();
                        this.ctx.arc(bullet.x, bullet.y, ballSize * 1.5, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        this.ctx.fillStyle = 'rgba(255, 77, 255, 1)';
                    }
                    
                    this.ctx.beginPath();
                    this.ctx.arc(bullet.x, bullet.y, ballSize, 0, Math.PI * 2);
                    this.ctx.fill();

                    const playerRect = { x: this.playerPos.x, y: this.playerPos.y, width: this.playerSize, height: this.playerSize };
                    // æ•Œäººå­å¼¹ç¢°æ’æ£€æµ‹ä½¿ç”¨ä¸€ä¸ªæ¯”å®é™…ç»˜åˆ¶ç¨å¤§çš„åŒºåŸŸ
                    const bulletRect = { x: bullet.x - ballSize, y: bullet.y - ballSize, width: ballSize * 2, height: ballSize * 2 };

                    if (!this.invulnerable && this.checkCollision(playerRect, bulletRect)) {
                        this.drawExplosion(
                            this.playerPos.x + this.playerSize/2,
                            this.playerPos.y + this.playerSize/2,
                            this.playerSize/2
                        );
                        this.explosionSound.currentTime = 0;
                        this.explosionSound.play().catch(e => console.log("playSoundFail:", e));

                        this.lives--;
                        if (this.lives <= 0) {
                            this.gameOver();
                            return;
                        }
                        this.invulnerable = true;
                        this.invulnerableTimer = 2;
                        this.enemyBullets.splice(i, 1);
                    }
                    
                    // å¤šäººæ¨¡å¼ä¸‹æ£€æŸ¥å…¶ä»–ç©å®¶æ˜¯å¦è¢«å‡»ä¸­
                    if (this.isMultiplayerMode) {
                        Object.keys(this.otherPlayers).forEach(id => {
                            const player = this.otherPlayers[id];
                            const otherPlayerRect = { 
                                x: player.x, 
                                y: player.y, 
                                width: this.playerSize, 
                                height: this.playerSize 
                            };
                            
                            if (this.checkCollision(otherPlayerRect, bulletRect)) {
                                this.drawExplosion(
                                    player.x + this.playerSize/2,
                                    player.y + this.playerSize/2,
                                    this.playerSize/2
                                );
                                
                                // æ¨¡æ‹Ÿå…¶ä»–ç©å®¶å—ä¼¤
                                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™åº”è¯¥é€šè¿‡ç½‘ç»œåŒæ­¥
                                this.enemyBullets.splice(i, 1);
                                break;
                            }
                        });
                    }
                }
            }

            drawExplosion(x, y, size) {
                 const colors = [
                    'rgba(255, 179, 51, 1)',
                    'rgba(255, 128, 26, 1)',
                    'rgba(255, 77, 26, 1)',
                    'rgba(230, 26, 26, 1)'
                ];

                for (let r = 1; r <= 4; r++) {
                    for (let j = 1; j <= 8; j++) { // ä¿®æ”¹å˜é‡åé¿å…å†²çª
                        const angle = j * Math.PI / 4;
                        const distance = size * r / 4;
                        const xp = x + Math.cos(angle) * distance * (0.7 + 0.3 * Math.random());
                        const yp = y + Math.sin(angle) * distance * (0.7 + 0.3 * Math.random());
                        const rad = size * (0.3 - r * 0.05) * (0.7 + 0.3 * Math.random());

                        this.ctx.fillStyle = colors[r - 1];
                        this.ctx.beginPath();
                        this.ctx.arc(xp, yp, rad, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                }
            }

            drawInfoPanel() {
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                this.ctx.fillRect(0, 0, 150, 130); // å¢åŠ é«˜åº¦ä»¥å®¹çº³è§’è‰²ç­‰çº§

                this.ctx.fillStyle = 'white';
                this.ctx.font = '12px Arial';
                this.ctx.fillText(`åˆ†æ•°: ${this.score}`, 10, 20);
                this.ctx.fillText(`ç”Ÿå‘½: ${this.lives}`, 10, 40);
                this.ctx.fillText(`æ¸¸æˆç­‰çº§: ${this.level}`, 10, 60);
                this.ctx.fillText(`è§’è‰²ç­‰çº§: ${this.characterLevel}`, 10, 80); // æ˜¾ç¤ºè§’è‰²ç­‰çº§

                this.ctx.fillStyle = this.invulnerable ? 'yellow' : 'white'; // Highlight when invulnerable
                this.ctx.fillText(`æ— æ•Œ: ${this.invulnerable ? this.invulnerableTimer.toFixed(1) : 'å¦'}`, 10, 100);
                
                // å¤šäººæ¨¡å¼ä¸‹æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯
                if (this.isMultiplayerMode) {
                    this.ctx.fillStyle = 'cyan';
                    this.ctx.fillText(`æˆ¿é—´: ${this.roomId}`, 10, 120);
                }
            }

            levelUp() {
                this.level++;
                this.lives++; // å‡ä¸€çº§è¡€é‡åŠ ä¸€
                this.enemySpeed *= 1.04;
                this.spawnRate = Math.min(this.spawnRate * 1.08, 0.07);
                this.enemyFireRate = Math.min(this.enemyFireRate * 1.08, 0.035);
                this.characterLevelUp();

                this.ctx.font = '24px Arial';
                this.ctx.fillStyle = 'yellow';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(`æ¸¸æˆç­‰çº§ ${this.level} !`, this.canvas.width / 2, this.canvas.height / 2 - 30);
                this.ctx.textAlign = 'left';

                this.levelUpSound.currentTime = 0;
                this.levelUpSound.play().catch(e => console.log("æ’­æ”¾éŸ³æ•ˆå¤±è´¥:", e));
            }

            characterLevelUp() {
                if (this.characterLevel < this.maxCharacterLevel) {
                    this.characterLevel++;
                    this.invulnerable = true;
                    this.invulnerableTimer = 1; // è§’è‰²å‡çº§åçŸ­æš‚æ— æ•Œ
                    console.log(`è§’è‰²å‡çº§åˆ°ç­‰çº§ ${this.characterLevel}!`);
                    if (this.characterLevel === this.maxCharacterLevel) {
                        console.log("è§’è‰²è¾¾åˆ°æœ€é«˜ç­‰çº§! æ”»å‡»å˜ä¸ºæ¿€å…‰!");
                        this.ctx.font = '20px Arial';
                        this.ctx.fillStyle = 'aqua';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(`æ”»å‡»å¼ºåŒ–: æ¿€å…‰!`, this.canvas.width / 2, this.canvas.height / 2);
                        this.ctx.textAlign = 'left';
                    }
                } else {
                    console.log("è§’è‰²å·²è¾¾åˆ°æœ€é«˜ç­‰çº§!");
                }
            }

            gameOver() {
                this.gameActive = false;
                this.bgMusic.pause();
                this.gameOverScreen.style.display = 'block';
                this.finalScoreText.textContent = `æœ€ç»ˆåˆ†æ•°: ${this.score}`;
                this.addScoreToLeaderboard(this.score);
                this.waitForRestart = true;
                
                // å¤šäººæ¨¡å¼ä¸‹ç»“æŸæ¸¸æˆ
                if (this.isMultiplayerMode) {
                    // å‘æœåŠ¡å™¨å‘é€æ¸¸æˆç»“æŸä¿¡æ¯
                    console.log("å¤šäººæ¸¸æˆç»“æŸï¼Œåˆ†æ•°ï¼š" + this.score);
                    this.isMultiplayerMode = false;
                }
            }

            checkCollision(rect1, rect2) {
                // æ£€æŸ¥ä¸¤ä¸ªçŸ©å½¢æ˜¯å¦ç¢°æ’
                // rect1 å’Œ rect2 éƒ½æ˜¯å¯¹è±¡ï¼ŒåŒ…å« x, y, width, height
                return rect1.x < rect2.x + rect2.width &&
                       rect1.x + rect1.width > rect2.x &&
                       rect1.y < rect2.y + rect2.height &&
                       rect1.y + rect1.height > rect2.y;
            }

            // æ’è¡Œæ¦œç›¸å…³æ–¹æ³•
            loadLeaderboard() {
                const data = localStorage.getItem('pokemonSpaceGameLeaderboard');
                return data ? JSON.parse(data) : [];
            }

            saveLeaderboard() {
                localStorage.setItem('pokemonSpaceGameLeaderboard', JSON.stringify(this.leaderboardData));
            }

            addScoreToLeaderboard(score) {
                // åœ¨å¤šäººæ¨¡å¼ä¸‹ï¼Œæ·»åŠ ç©å®¶åç§°å’Œåˆ†æ•°
                if (this.isMultiplayerMode && this.playerName) {
                    this.leaderboardData.push({
                        name: this.playerName,
                        score: score,
                        date: new Date().toLocaleDateString()
                    });
                } else {
                    // å•äººæ¨¡å¼ä¸‹åªä¿å­˜åˆ†æ•°
                    this.leaderboardData.push({
                        name: "æœ¬åœ°ç©å®¶",
                        score: score,
                        date: new Date().toLocaleDateString()
                    });
                }
                
                // æŒ‰åˆ†æ•°é™åºæ’åº
                this.leaderboardData.sort((a, b) => {
                    if (typeof a === 'object' && typeof b === 'object') {
                        return b.score - a.score;
                    } else if (typeof a === 'object') {
                        return b - a.score;
                    } else if (typeof b === 'object') {
                        return b.score - a;
                    } else {
                        return b - a;
                    }
                });
                
                // åªä¿ç•™å‰10å
                this.leaderboardData = this.leaderboardData.slice(0, 10);
                this.saveLeaderboard();
                this.updateLeaderboardDisplay(); // æ¸¸æˆç»“æŸåæ›´æ–°æ˜¾ç¤º
            }

            updateLeaderboardDisplay() {
                this.leaderboardList.innerHTML = ''; // æ¸…ç©ºæ—§åˆ—è¡¨
                if (this.leaderboardData.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'æš‚æ— è®°å½•';
                    this.leaderboardList.appendChild(li);
                } else {
                                        this.leaderboardData.forEach((entry, index) => {
                        const li = document.createElement('li');
                        // å¤„ç†ä¸åŒæ ¼å¼çš„æ’è¡Œæ¦œæ•°æ®
                        if (typeof entry === 'object') {
                            li.textContent = `${index + 1}. ${entry.name}: ${entry.score} åˆ† (${entry.date || 'æœªçŸ¥æ—¥æœŸ'})`;
                        } else {
                            li.textContent = `${index + 1}. æœ¬åœ°ç©å®¶: ${entry} åˆ†`;
                        }
                        this.leaderboardList.appendChild(li);
                    });
                }
            }
        }

        // å½“é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æ¸¸æˆ
        window.onload = function() {
            new PokemonSpaceGame();
        };
    </script>
</body>
</html>

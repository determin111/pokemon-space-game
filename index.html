<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>宝可梦太空对战</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        #gameContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
        }

        #gameCanvas {
            border: 3px solid #fff;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            max-width: 90vw;
            max-height: 90vh;
            display: none;
        }

        #introScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000;
            cursor: pointer;
        }

        #introScreen h1 {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #00ff88;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #00ff88, 0 0 30px #00ff88; }
            to { text-shadow: 0 0 30px #00ff88, 0 0 40px #00ff88, 0 0 50px #00ff88; }
        }

        #introScreen p {
            font-size: 1.5em;
            opacity: 0.8;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 2000;
            border: 2px solid #ff4444;
        }

        .game-over h1 {
            color: #ff4444;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ff4444;
        }

        .ui-button {
            position: absolute;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .ui-button:hover {
            background: rgba(0, 255, 136, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        #pauseBtn { top: 20px; right: 20px; }
        #leaderboardBtn { top: 20px; left: 20px; }
        #multiplayerBtn { top: 20px; left: 150px; }

        #joystick {
            position: absolute;
            bottom: 50px;
            left: 50px;
            width: 120px;
            height: 120px;
            background: rgba(0, 0, 0, 0.6);
            border: 3px solid #00ff88;
            border-radius: 50%;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #joystickHandle {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #00ff88, #00ccaa);
            border-radius: 50%;
            position: absolute;
            transition: all 0.1s ease;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        #fireButton {
            position: absolute;
            bottom: 50px;
            right: 50px;
            width: 90px;
            height: 90px;
            background: radial-gradient(circle, #ff4444, #cc0000);
            border: 3px solid #fff;
            border-radius: 50%;
            color: white;
            font-size: 30px;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
            transition: all 0.2s ease;
        }

        #fireButton:active {
            transform: scale(0.9);
            box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
        }

        #leaderboard {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #00ff88;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            min-width: 250px;
        }

        #leaderboard h2 {
            color: #00ff88;
            margin-bottom: 15px;
            text-align: center;
        }

        #multiplayerPanel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00ff88;
            display: none;
            z-index: 3000;
            width: 90%;
            max-width: 400px;
        }

        #multiplayerPanel h2 {
            color: #00ff88;
            text-align: center;
            margin-bottom: 20px;
        }

        #multiplayerPanel input, #multiplayerPanel button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border: 2px solid #00ff88;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        #multiplayerPanel button {
            background: linear-gradient(45deg, #00ff88, #00ccaa);
            color: black;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #multiplayerPanel button:hover {
            background: linear-gradient(45deg, #00ccaa, #00ff88);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .player-list {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        .player-item {
            padding: 8px;
            margin: 5px 0;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 5px;
            border-left: 3px solid #00ff88;
        }

        .hidden { display: none !important; }
        .visible { display: block !important; }
        .flex { display: flex !important; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="introScreen">
            <h1>🚀 宝可梦太空对战 🌟</h1>
            <p>点击开始你的太空冒险！</p>
        </div>

        <canvas id="gameCanvas" width="400" height="600"></canvas>

        <div class="game-over" id="gameOverScreen">
            <h1>游戏结束</h1>
            <p id="finalScore">最终分数: 0</p>
            <p>点击任意位置重新开始</p>
        </div>

        <button class="ui-button" id="pauseBtn">⏸️ 暂停</button>
        <button class="ui-button" id="leaderboardBtn">🏆 排行榜</button>
        <button class="ui-button" id="multiplayerBtn">👥 多人游戏</button>

        <div id="joystick">
            <div id="joystickHandle"></div>
        </div>

        <div id="fireButton">🔥</div>

        <div id="leaderboard">
            <h2>🏆 排行榜</h2>
            <div id="leaderboardList"></div>
        </div>

        <div id="multiplayerPanel">
            <h2>👥 多人游戏模式</h2>
            <input type="text" id="playerName" placeholder="输入你的游戏名称" maxlength="12">
            <button id="createRoomBtn">🎮 创建房间</button>
            <button id="joinRoomBtn">🚪 加入房间</button>
            <input type="text" id="roomIdInput" placeholder="输入房间ID" style="display:none;" maxlength="8">
            <button id="startGameBtn" style="display:none;">🚀 开始游戏</button>
            <div class="player-list" id="playerListContainer">
                <h3>在线玩家</h3>
                <div id="playerList"></div>
            </div>
            <button id="closePanelBtn">❌ 关闭</button>
        </div>
    </div>

    <script>
        class PokemonSpaceGame {
            constructor() {
                this.initializeElements();
                this.initializeGameState();
                this.loadAssets();
                this.setupEventListeners();
                this.setupInputHandlers();
                this.lastTime = 0;
            }

            initializeElements() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.introScreen = document.getElementById('introScreen');
                this.gameOverScreen = document.getElementById('gameOverScreen');
                this.finalScoreText = document.getElementById('finalScore');
                this.leaderboard = document.getElementById('leaderboard');
                this.leaderboardList = document.getElementById('leaderboardList');
                this.multiplayerPanel = document.getElementById('multiplayerPanel');
                this.playerNameInput = document.getElementById('playerName');
                this.roomIdInput = document.getElementById('roomIdInput');
                this.playerList = document.getElementById('playerList');
                this.joystick = document.getElementById('joystick');
                this.joystickHandle = document.getElementById('joystickHandle');
                this.fireButton = document.getElementById('fireButton');
            }

            initializeGameState() {
                // Game state
                this.gameActive = false;
                this.gamePaused = false;
                this.waitForRestart = false;
                this.inIntro = true;

                // Player stats
                this.score = 0;
                this.lives = 7;
                this.level = 1;
                this.nextLevelScore = 25;
                this.invulnerable = false;
                this.invulnerableTimer = 0;
                this.characterLevel = 1;
                this.maxCharacterLevel = 6;

                // Player properties
                this.playerSize = 70;
                this.playerPos = { x: 165, y: 480 };
                this.playerSpeed = 6;
                this.moveLeft = false;
                this.moveRight = false;
                this.moveUp = false;
                this.moveDown = false;

                // Bullets
                this.bullets = [];
                this.bulletSpeed = 10;
                this.lastShotTime = 0;
                this.shotCooldown = 150;

                // Enemies
                this.enemies = [];
                this.enemyBullets = [];
                this.enemySize = 45;
                this.enemySpeed = 1.5;
                this.spawnRate = 0.015;
                this.maxEnemies = 5;

                // Laser system
                this.laserActive = false;
                this.laserTimer = 0;
                this.laserDuration = 2;

                // Multiplayer
                this.isMultiplayerMode = false;
                this.roomId = null;
                this.playerName = "";
                this.otherPlayers = {};
                this.multiplayerScores = [];

                // Visual effects
                this.explosions = [];
                this.particles = [];

                // Background stars
                this.stars = [];
                this.generateStars();

                // Leaderboard
                this.leaderboardData = this.loadLeaderboard();
            }

            loadAssets() {
                // Create player sprites programmatically
                this.playerImages = {};
                for (let i = 1; i <= this.maxCharacterLevel; i++) {
                    this.playerImages[i] = this.createPlayerSprite(i);
                }

                // Create enemy sprite
                this.enemyImage = this.createEnemySprite();
                
                // Create sounds (using Web Audio API for better performance)
                this.initializeAudio();
            }

            createPlayerSprite(level) {
                const canvas = document.createElement('canvas');
                canvas.width = this.playerSize;
                canvas.height = this.playerSize;
                const ctx = canvas.getContext('2d');

                // Base colors for different levels
                const colors = [
                    '#4CAF50', '#2196F3', '#FF9800', 
                    '#E91E63', '#9C27B0', '#FF5722'
                ];
                const color = colors[level - 1] || colors[0];

                // Draw spaceship
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2, 5);
                ctx.lineTo(canvas.width * 0.8, canvas.height * 0.7);
                ctx.lineTo(canvas.width * 0.6, canvas.height * 0.9);
                ctx.lineTo(canvas.width * 0.4, canvas.height * 0.9);
                ctx.lineTo(canvas.width * 0.2, canvas.height * 0.7);
                ctx.closePath();
                ctx.fill();

                // Add details based on level
                ctx.fillStyle = '#FFD700';
                for (let i = 0; i < level; i++) {
                    ctx.beginPath();
                    ctx.arc(canvas.width / 2, 20 + i * 8, 3, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Add glow effect for higher levels
                if (level >= 3) {
                    ctx.shadowColor = color;
                    ctx.shadowBlur = 10;
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                return canvas;
            }

            createEnemySprite() {
                const canvas = document.createElement('canvas');
                canvas.width = this.enemySize;
                canvas.height = this.enemySize;
                const ctx = canvas.getContext('2d');

                // Draw enemy spaceship
                ctx.fillStyle = '#FF4444';
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2, canvas.height - 5);
                ctx.lineTo(canvas.width * 0.8, canvas.height * 0.3);
                ctx.lineTo(canvas.width * 0.6, canvas.height * 0.1);
                ctx.lineTo(canvas.width * 0.4, canvas.height * 0.1);
                ctx.lineTo(canvas.width * 0.2, canvas.height * 0.3);
                ctx.closePath();
                ctx.fill();

                // Add details
                ctx.fillStyle = '#FFFF00';
                ctx.beginPath();
                ctx.arc(canvas.width / 2, canvas.height * 0.7, 4, 0, Math.PI * 2);
                ctx.fill();

                return canvas;
            }

            initializeAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.sounds = {
                        shoot: this.createShootSound(),
                        explosion: this.createExplosionSound(),
                        laser: this.createLaserSound(),
                        levelUp: this.createLevelUpSound()
                    };
                } catch (e) {
                    console.log('Audio not supported');
                    this.sounds = {};
                }
            }

            createShootSound() {
                // Create a simple shoot sound using oscillator
                const duration = 0.1;
                return () => {
                    if (!this.audioContext) return;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(200, this.audioContext.currentTime + duration);
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                };
            }

            createExplosionSound() {
                const duration = 0.3;
                return () => {
                    if (!this.audioContext) return;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(150, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(50, this.audioContext.currentTime + duration);
                    
                    gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                };
            }

            createLaserSound() {
                const duration = 2;
                return () => {
                    if (!this.audioContext) return;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(1000, this.audioContext.currentTime);
                    oscillator.frequency.linearRampToValueAtTime(1200, this.audioContext.currentTime + duration);
                    
                    gainNode.gain.setValueAtTime(0.15, this.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                };
            }

            createLevelUpSound() {
                const duration = 0.5;
                return () => {
                    if (!this.audioContext) return;
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(400, this.audioContext.currentTime);
                    oscillator.frequency.linearRampToValueAtTime(800, this.audioContext.currentTime + duration);
                    
                    gainNode.gain.setValueAtTime(0.1, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                };
            }

            generateStars() {
                for (let i = 0; i < 100; i++) {
                    this.stars.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        size: Math.random() * 2 + 1,
                        speed: Math.random() * 2 + 1,
                        brightness: Math.random()
                    });
                }
            }

            setupEventListeners() {
                // Intro screen
                this.introScreen.addEventListener('click', () => this.startGame());
                this.introScreen.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startGame();
                });

                // UI buttons
                document.getElementById('pauseBtn').addEventListener('click', () => this.togglePause());
                document.getElementById('leaderboardBtn').addEventListener('click', () => this.toggleLeaderboard());
                document.getElementById('multiplayerBtn').addEventListener('click', () => this.showMultiplayerPanel());

                // Multiplayer panel
                document.getElementById('createRoomBtn').addEventListener('click', () => this.createRoom());
                document.getElementById('joinRoomBtn').addEventListener('click', () => this.joinRoom());
                document.getElementById('startGameBtn').addEventListener('click', () => this.startMultiplayerGame());
                document.getElementById('closePanelBtn').addEventListener('click', () => this.closeMultiplayerPanel());

                // Game over screen
                this.gameOverScreen.addEventListener('click', () => this.restart());
                this.gameOverScreen.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.restart();
                });

                // Fire button
                this.fireButton.addEventListener('mousedown', () => this.fireBullet());
                this.fireButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.fireBullet();
                });
            }

            setupInputHandlers() {
                // Keyboard controls
                document.addEventListener('keydown', (e) => this.handleKeyDown(e));
                document.addEventListener('keyup', (e) => this.handleKeyUp(e));

                // Touch controls for joystick
                this.setupJoystickControls();
            }

            setupJoystickControls() {
                let joystickActive = false;
                let joystickCenter = { x: 0, y: 0 };

                const updateJoystick = (touch) => {
                    if (!joystickActive) return;

                    const rect = this.joystick.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    const deltaX = touch.clientX - centerX;
                    const deltaY = touch.clientY - centerY;
                    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                    const maxDistance = 30;

                    let moveX = deltaX;
                    let moveY = deltaY;

                    if (distance > maxDistance) {
                        moveX = (deltaX / distance) * maxDistance;
                        moveY = (deltaY / distance) * maxDistance;
                    }

                    this.joystickHandle.style.transform = `translate(${moveX}px, ${moveY}px)`;

                    // Set movement flags
                    this.moveLeft = moveX < -10;
                    this.moveRight = moveX > 10;
                    this.moveUp = moveY < -10;
                    this.moveDown = moveY > 10;
                };

                this.joystick.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    joystickActive = true;
                    updateJoystick(e.touches[0]);
                });

                this.joystick.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    updateJoystick(e.touches[0]);
                });

                this.joystick.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    joystickActive = false;
                    this.joystickHandle.style.transform = 'translate(0px, 0px)';
                    this.moveLeft = this.moveRight = this.moveUp = this.moveDown = false;
                });
            }

            handleKeyDown(e) {
                if (this.waitForRestart) {
                    this.restart();
                    return;
                }

                switch (e.key) {
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        this.moveLeft = true;
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        this.moveRight = true;
                        break;
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        this.moveUp = true;
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        this.moveDown = true;
                        break;
                    case ' ':
                        e.preventDefault();
                        this.fireBullet();
                        break;
                    case 'p':
                    case 'P':
                        this.togglePause();
                        break;
                    case 'l':
                    case 'L':
                        this.toggleLeaderboard();
                        break;
                }
            }

            handleKeyUp(e) {
                switch (e.key) {
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        this.moveLeft = false;
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        this.moveRight = false;
                        break;
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        this.moveUp = false;
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        this.moveDown = false;
                        break;
                }
            }

            startGame() {
                this.introScreen.style.display = 'none';
                this.canvas.style.display = 'block';
                this.joystick.style.display = 'flex';
                this.fireButton.style.display = 'flex';
                
                document.querySelector('#pauseBtn').style.display = 'block';
                document.querySelector('#leaderboardBtn').style.display = 'block';
                document.querySelector('#multiplayerBtn').style.display = 'block';

                this.inIntro = false;
                this.gameActive = true;
                this.lastTime = performance.now();
                this.gameLoop();
            }

            fireBullet() {
                if (!this.gameActive || this.gamePaused) return;

                const now = performance.now();
                if (now - this.lastShotTime < this.shotCooldown) return;

                this.lastShotTime = now;

                // Main bullet
                this.bullets.push({
                    x: this.playerPos.x + this.playerSize / 2,
                    y: this.playerPos.y,
                    speed: this.bulletSpeed
                });

                // Additional bullets based on character level
                if (this.characterLevel >= 3) {
                    this.bullets.push({
                        x: this.playerPos.x + this.playerSize * 0.3,
                        y: this.playerPos.y,
                        speed: this.bulletSpeed
                    });
                }

                if (this.characterLevel >= 5) {
                    this.bullets.push({
                        x: this.playerPos.x + this.playerSize * 0.7,
                        y: this.playerPos.y,
                        speed: this.bulletSpeed
                    });
                }

                this.playSound('shoot');
            }

            playSound(soundName) {
                if (this.sounds[soundName]) {
                    this.sounds[soundName]();
                }
            }

            // Multiplayer methods
            showMultiplayerPanel() {
                this.gamePaused = true;
                this.multiplayerPanel.style.display = 'block';
            }

            closeMultiplayerPanel() {
                this.gamePaused = false;
                this.multiplayerPanel.style.display = 'none';
                this.roomIdInput.style.display = 'none';
                document.getElementById('startGameBtn').style.display = 'none';
            }

            createRoom() {
                const name = this.playerNameInput.value.trim();
                if (!name) {
                    alert('请输入你的游戏名称！');
                    return;
                }

                this.playerName = name;
                this.roomId = this.generateRoomId();
                this.isMultiplayerMode = true;

                // Simulate adding other players
                this.otherPlayers = {
                    'Player2': {
                        name: 'AI玩家1',
                        pos: { x: 100, y: 400 },
                        score: 0,
                        level: 1
                    },
                    'Player3': {
                        name: 'AI玩家2',
                        pos: { x: 250, y: 420 },
                        score: 0,
                        level: 1
                    }
                };

                this.updatePlayerList();
                document.getElementById('startGameBtn').style.display = 'block';
                alert(`房间已创建！房间ID: ${this.roomId}`);
            }

            joinRoom() {
                const name = this.playerNameInput.value.trim();
                if (!name) {
                    alert('请输入你的游戏名称！');
                    return;
                }

                this.roomIdInput.style.display = 'block';
                const roomId = this.roomIdInput.value.trim();
                if (!roomId) return;

                this.playerName = name;
                this.roomId = roomId;
                this.isMultiplayerMode = true;

                // Simulate joining room
                this.otherPlayers = {
                    'Host': {
                        name: '房主',
                        pos: { x: 200, y: 450 },
                        score: 50,
                        level: 2
                    }
                };

                this.updatePlayerList();
                alert(`已加入房间: ${roomId}`);
            }

            updatePlayerList() {
                this.playerList.innerHTML = '';
                
                // Add self
                const selfDiv = document.createElement('div');
                selfDiv.className = 'player-item';
                selfDiv.innerHTML = `${this.playerName} (你) - 分数: ${this.score}`;
                this.playerList.appendChild(selfDiv);

                // Add other players
                Object.values(this.otherPlayers).forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player-item';
                    playerDiv.innerHTML = `${player.name} - 分数: ${player.score}`;
                    this.playerList.appendChild(playerDiv);
                });

                this.updateMultiplayerScores();
            }

            updateMultiplayerScores() {
                this.multiplayerScores = [
                    { name: this.playerName, score: this.score }
                ];

                Object.values(this.otherPlayers).forEach(player => {
                    this.multiplayerScores.push({
                        name: player.name,
                        score: player.score
                    });
                });

                this.multiplayerScores.sort((a, b) => b.score - a.score);
            }

            startMultiplayerGame() {
                this.closeMultiplayerPanel();
                this.gameActive = true;
                this.lastTime = performance.now();
                this.gameLoop();
            }

            generateRoomId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            // Game logic methods
            update(deltaTime) {
                if (!this.gameActive || this.gamePaused) return;

                this.updatePlayer(deltaTime);
                this.updateBullets(deltaTime);
                this.updateEnemies(deltaTime);
                this.updateEnemyBullets(deltaTime);
                this.updateLaser(deltaTime);
                this.updateEffects(deltaTime);
                this.updateStars(deltaTime);
                
                if (this.isMultiplayerMode) {
                    this.updateOtherPlayers(deltaTime);
                }

                this.checkCollisions();
                this.spawnEnemies();
                this.updateInvulnerability(deltaTime);
            }

            updatePlayer(deltaTime) {
                const speed = this.playerSpeed * deltaTime / 16;

                if (this.moveLeft) {
                    this.playerPos.x = Math.max(0, this.playerPos.x - speed);
                }
                if (this.moveRight) {
                    this.playerPos.x = Math.min(this.canvas.width - this.playerSize, this.playerPos.x + speed);
                }
                if (this.moveUp) {
                    this.playerPos.y = Math.max(0, this.playerPos.y - speed);
                }
                if (this.moveDown) {
                    this.playerPos.y = Math.min(this.canvas.height - this.playerSize, this.playerPos.y + speed);
                }
            }

            updateBullets(deltaTime) {
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    bullet.y -= bullet.speed * deltaTime / 16;

                    if (bullet.y < 0) {
                        this.bullets.splice(i, 1);
                    }
                }
            }

            updateEnemies(deltaTime) {
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    enemy.y += this.enemySpeed * (1 + this.level * 0.1) * deltaTime / 16;

                    // Random shooting
                    if (Math.random() < 0.005 * deltaTime / 16) {
                        this.enemyBullets.push({
                            x: enemy.x + this.enemySize / 2,
                            y: enemy.y + this.enemySize,
                            speed: 3
                        });
                    }

                    if (enemy.y > this.canvas.height) {
                        this.enemies.splice(i, 1);
                    }
                }
            }

            updateEnemyBullets(deltaTime) {
                for (let i = this.enemyBullets.length - 1; i >= 0; i--) {
                    const bullet = this.enemyBullets[i];
                    bullet.y += bullet.speed * deltaTime / 16;

                    if (bullet.y > this.canvas.height) {
                        this.enemyBullets.splice(i, 1);
                    }
                }
            }

            updateLaser(deltaTime) {
                if (this.laserActive) {
                    this.laserTimer -= deltaTime / 1000;
                    if (this.laserTimer <= 0) {
                        this.laserActive = false;
                    }
                    this.handleLaserCollisions();
                }
            }

            updateEffects(deltaTime) {
                // Update explosions
                for (let i = this.explosions.length - 1; i >= 0; i--) {
                    const explosion = this.explosions[i];
                    explosion.life -= deltaTime / 1000;
                    explosion.size += explosion.growthRate * deltaTime / 16;
                    
                    if (explosion.life <= 0) {
                        this.explosions.splice(i, 1);
                    }
                }

                // Update particles
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const particle = this.particles[i];
                    particle.x += particle.vx * deltaTime / 16;
                    particle.y += particle.vy * deltaTime / 16;
                    particle.life -= deltaTime / 1000;
                    
                    if (particle.life <= 0) {
                        this.particles.splice(i, 1);
                    }
                }
            }

            updateStars(deltaTime) {
                for (const star of this.stars) {
                    star.y += star.speed * deltaTime / 16;
                    if (star.y > this.canvas.height) {
                        star.y = 0;
                        star.x = Math.random() * this.canvas.width;
                    }
                }
            }

            updateOtherPlayers(deltaTime) {
                // Simulate other players' movement and scoring
                Object.values(this.otherPlayers).forEach(player => {
                    if (Math.random() < 0.02) {
                        player.pos.x += (Math.random() - 0.5) * 3;
                        player.pos.x = Math.max(0, Math.min(this.canvas.width - this.playerSize, player.pos.x));
                    }
                    if (Math.random() < 0.01) {
                        player.score += Math.floor(Math.random() * 5) + 1;
                    }
                });
                
                if (Math.random() < 0.05) {
                    this.updateMultiplayerScores();
                }
            }

            updateInvulnerability(deltaTime) {
                if (this.invulnerable) {
                    this.invulnerableTimer -= deltaTime / 1000;
                    if (this.invulnerableTimer <= 0) {
                        this.invulnerable = false;
                    }
                }
            }

            checkCollisions() {
                // Player bullets vs enemies
                for (let i = this.bullets.length - 1; i >= 0; i--) {
                    const bullet = this.bullets[i];
                    for (let j = this.enemies.length - 1; j >= 0; j--) {
                        const enemy = this.enemies[j];
                        if (this.isColliding(bullet, enemy, 4, this.enemySize)) {
                            this.createExplosion(enemy.x + this.enemySize / 2, enemy.y + this.enemySize / 2);
                            this.bullets.splice(i, 1);
                            this.enemies.splice(j, 1);
                            this.score += 10;
                            this.playSound('explosion');
                            this.checkLevelUp();
                            break;
                        }
                    }
                }

                // Enemy bullets vs player
                if (!this.invulnerable) {
                    for (let i = this.enemyBullets.length - 1; i >= 0; i--) {
                        const bullet = this.enemyBullets[i];
                        if (this.isColliding(bullet, this.playerPos, 6, this.playerSize)) {
                            this.createExplosion(this.playerPos.x + this.playerSize / 2, this.playerPos.y + this.playerSize / 2);
                            this.enemyBullets.splice(i, 1);
                            this.lives--;
                            this.invulnerable = true;
                            this.invulnerableTimer = 2;
                            this.playSound('explosion');
                            
                            if (this.lives <= 0) {
                                this.gameOver();
                            }
                            break;
                        }
                    }

                    // Enemies vs player
                    for (let i = this.enemies.length - 1; i >= 0; i--) {
                        const enemy = this.enemies[i];
                        if (this.isColliding(enemy, this.playerPos, this.enemySize, this.playerSize)) {
                            this.createExplosion(this.playerPos.x + this.playerSize / 2, this.playerPos.y + this.playerSize / 2);
                            this.enemies.splice(i, 1);
                            this.lives--;
                            this.invulnerable = true;
                            this.invulnerableTimer = 2;
                            this.playSound('explosion');
                            
                            if (this.lives <= 0) {
                                this.gameOver();
                            }
                            break;
                        }
                    }
                }
            }

            handleLaserCollisions() {
                const laserX = this.playerPos.x + this.playerSize / 2;
                for (let i = this.enemies.length - 1; i >= 0; i--) {
                    const enemy = this.enemies[i];
                    if (Math.abs(enemy.x + this.enemySize / 2 - laserX) < this.enemySize / 2) {
                        this.createExplosion(enemy.x + this.enemySize / 2, enemy.y + this.enemySize / 2);
                        this.enemies.splice(i, 1);
                        this.score += 15;
                    }
                }
            }

            isColliding(obj1, obj2, size1, size2) {
                return obj1.x < obj2.x + size2 &&
                       obj1.x + size1 > obj2.x &&
                       obj1.y < obj2.y + size2 &&
                       obj1.y + size1 > obj2.y;
            }

            spawnEnemies() {
                if (this.enemies.length < this.maxEnemies && Math.random() < this.spawnRate) {
                    this.enemies.push({
                        x: Math.random() * (this.canvas.width - this.enemySize),
                        y: -this.enemySize
                    });
                }
            }

            checkLevelUp() {
                if (this.score >= this.nextLevelScore) {
                    this.level++;
                    this.nextLevelScore *= 2;
                    this.maxEnemies = Math.min(8, this.maxEnemies + 1);
                    this.spawnRate = Math.min(0.03, this.spawnRate * 1.2);
                    this.playSound('levelUp');

                    // Activate laser every 3 levels
                    if (this.level % 3 === 0) {
                        this.activateLaser();
                    }

                    // Upgrade character every 2 levels
                    if (this.level % 2 === 0 && this.characterLevel < this.maxCharacterLevel) {
                        this.characterLevel++;
                    }
                }
            }

            activateLaser() {
                this.laserActive = true;
                this.laserTimer = this.laserDuration;
                this.playSound('laser');
            }

            createExplosion(x, y) {
                this.explosions.push({
                    x: x,
                    y: y,
                    size: 0,
                    life: 0.5,
                    growthRate: 2,
                    color: `hsl(${Math.random() * 60 + 15}, 100%, 60%)`
                });

                // Add particles
                for (let i = 0; i < 8; i++) {
                    const angle = (i / 8) * Math.PI * 2;
                    this.particles.push({
                        x: x,
                        y: y,
                        vx: Math.cos(angle) * 3,
                        vy: Math.sin(angle) * 3,
                        life: 0.8,
                        color: `hsl(${Math.random() * 60 + 15}, 100%, 70%)`
                    });
                }
            }

            // Rendering methods
            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.drawBackground();
                this.drawStars();
                
                if (this.gameActive) {
                    this.drawLaser();
                    this.drawBullets();
                    this.drawEnemies();
                    this.drawEnemyBullets();
                    this.drawPlayer();
                    
                    if (this.isMultiplayerMode) {
                        this.drawOtherPlayers();
                    }
                    
                    this.drawEffects();
                    this.drawUI();
                }
            }

            drawBackground() {
                const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                gradient.addColorStop(0, '#000011');
                gradient.addColorStop(0.5, '#000033');
                gradient.addColorStop(1, '#000055');
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }

            drawStars() {
                for (const star of this.stars) {
                    this.ctx.fillStyle = `rgba(255, 255, 255, ${star.brightness})`;
                    this.ctx.beginPath();
                    this.ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }

            drawPlayer() {
                if (this.invulnerable && Math.floor(Date.now() / 100) % 2) {
                    return; // Flicker effect
                }

                const playerImage = this.playerImages[this.characterLevel];
                if (playerImage) {
                    this.ctx.drawImage(playerImage, this.playerPos.x, this.playerPos.y);
                }

                // Draw player name in multiplayer
                if (this.isMultiplayerMode && this.playerName) {
                    this.ctx.fillStyle = '#00FF88';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(this.playerName, this.playerPos.x + this.playerSize / 2, this.playerPos.y - 5);
                    this.ctx.textAlign = 'left';
                }
            }

            drawOtherPlayers() {
                Object.values(this.otherPlayers).forEach(player => {
                    const playerImage = this.playerImages[player.level || 1];
                    if (playerImage) {
                        this.ctx.drawImage(playerImage, player.pos.x, player.pos.y);
                    }

                    // Draw player name
                    this.ctx.fillStyle = '#FFD700';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(player.name, player.pos.x + this.playerSize / 2, player.pos.y - 5);
                    this.ctx.textAlign = 'left';
                });
            }

            drawBullets() {
                this.ctx.fillStyle = '#00FF88';
                for (const bullet of this.bullets) {
                    this.ctx.beginPath();
                    this.ctx.arc(bullet.x, bullet.y, 3, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // Add glow effect
                    this.ctx.shadowColor = '#00FF88';
                    this.ctx.shadowBlur = 10;
                    this.ctx.fill();
                    this.ctx.shadowBlur = 0;
                }
            }

            drawEnemies() {
                for (const enemy of this.enemies) {
                    this.ctx.drawImage(this.enemyImage, enemy.x, enemy.y);
                }
            }

            drawEnemyBullets() {
                this.ctx.fillStyle = '#FF4444';
                for (const bullet of this.enemyBullets) {
                    this.ctx.beginPath();
                    this.ctx.arc(bullet.x, bullet.y, 4, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }

            drawLaser() {
                if (this.laserActive) {
                    const gradient = this.ctx.createLinearGradient(0, 0, 0, this.playerPos.y);
                    gradient.addColorStop(0, 'rgba(255, 0, 0, 0.1)');
                    gradient.addColorStop(1, 'rgba(255, 0, 0, 0.8)');
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(this.playerPos.x + this.playerSize / 2 - 5, 0, 10, this.playerPos.y);
                    
                    // Add glow effect
                    this.ctx.shadowColor = '#FF0000';
                    this.ctx.shadowBlur = 20;
                    this.ctx.fillRect(this.playerPos.x + this.playerSize / 2 - 2, 0, 4, this.playerPos.y);
                    this.ctx.shadowBlur = 0;
                }
            }

            drawEffects() {
                // Draw explosions
                for (const explosion of this.explosions) {
                    this.ctx.fillStyle = explosion.color;
                    this.ctx.beginPath();
                    this.ctx.arc(explosion.x, explosion.y, explosion.size, 0, Math.PI * 2);
                    this.ctx.fill();
                }

                // Draw particles
                for (const particle of this.particles) {
                    this.ctx.fillStyle = particle.color;
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, 2, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }

            drawUI() {
                // Game info panel
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                this.ctx.fillRect(5, 5, 160, 120);
                
                this.ctx.fillStyle = '#00FF88';
                this.ctx.font = '14px Arial';
                this.ctx.fillText(`分数: ${this.score}`, 15, 25);
                this.ctx.fillText(`生命: ${this.lives}`, 15, 45);
                this.ctx.fillText(`等级: ${this.level}`, 15, 65);
                this.ctx.fillText(`角色等级: ${this.characterLevel}`, 15, 85);
                
                if (this.invulnerable) {
                    this.ctx.fillStyle = '#FFD700';
                    this.ctx.fillText(`无敌: ${this.invulnerableTimer.toFixed(1)}s`, 15, 105);
                }

                // Multiplayer room info
                if (this.isMultiplayerMode && this.roomId) {
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    this.ctx.fillRect(this.canvas.width - 120, 5, 115, 25);
                    this.ctx.fillStyle = '#FFD700';
                    this.ctx.font = '12px Arial';
                    this.ctx.fillText(`房间: ${this.roomId}`, this.canvas.width - 110, 22);
                }

                // Laser indicator
                if (this.laserActive) {
                    this.ctx.fillStyle = 'rgba(255, 0, 0, 0.8)';
                    this.ctx.fillRect(this.canvas.width / 2 - 50, 10, 100, 20);
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('激光激活!', this.canvas.width / 2, 23);
                    this.ctx.textAlign = 'left';
                }
            }

            // Game state methods
            togglePause() {
                this.gamePaused = !this.gamePaused;
                if (!this.gamePaused) {
                    this.lastTime = performance.now();
                    this.gameLoop();
                }
            }

            toggleLeaderboard() {
                const isVisible = this.leaderboard.style.display === 'block';
                this.leaderboard.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    this.updateLeaderboardDisplay();
                }
            }

            updateLeaderboardDisplay() {
                this.leaderboardList.innerHTML = '';
                
                const scores = this.isMultiplayerMode ? this.multiplayerScores : this.leaderboardData;
                const title = this.isMultiplayerMode ? '多人游戏排行榜' : '单人游戏排行榜';
                
                this.leaderboard.querySelector('h2').textContent = title;
                
                if (scores.length === 0) {
                    this.leaderboardList.innerHTML = '<div style="text-align: center; color: #888;">暂无记录</div>';
                } else {
                    scores.forEach((entry, index) => {
                        const div = document.createElement('div');
                        div.style.cssText = 'padding: 8px; margin: 4px 0; background: rgba(0, 255, 136, 0.1); border-radius: 5px; border-left: 3px solid #00FF88;';
                        div.innerHTML = `${index + 1}. ${entry.name} - ${entry.score}分`;
                        
                        if (this.isMultiplayerMode && entry.name === this.playerName) {
                            div.style.background = 'rgba(255, 215, 0, 0.2)';
                            div.style.borderLeftColor = '#FFD700';
                        }
                        
                        this.leaderboardList.appendChild(div);
                    });
                }
            }

            gameOver() {
                this.gameActive = false;
                this.waitForRestart = true;
                this.finalScoreText.textContent = `最终分数: ${this.score}`;
                this.gameOverScreen.style.display = 'block';
                
                if (!this.isMultiplayerMode) {
                    this.saveToLeaderboard();
                }
            }

            restart() {
                if (!this.waitForRestart) return;
                
                this.initializeGameState();
                this.gameOverScreen.style.display = 'none';
                this.gameActive = true;
                this.waitForRestart = false;
                this.lastTime = performance.now();
                this.gameLoop();
            }

            // Leaderboard methods
            loadLeaderboard() {
                try {
                    const data = localStorage.getItem('pokemonSpaceLeaderboard');
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    return [];
                }
            }

            saveToLeaderboard() {
                let name = this.playerName;
                if (!name) {
                    name = prompt('请输入你的名字保存分数:', '匿名玩家');
                    if (!name) return;
                }

                const entry = {
                    name: name,
                    score: this.score,
                    date: new Date().toISOString()
                };

                this.leaderboardData.push(entry);
                this.leaderboardData.sort((a, b) => b.score - a.score);
                this.leaderboardData = this.leaderboardData.slice(0, 10);

                try {
                    localStorage.setItem('pokemonSpaceLeaderboard', JSON.stringify(this.leaderboardData));
                } catch (e) {
                    console.log('Failed to save leaderboard');
                }
            }

            // Main game loop
            gameLoop(currentTime = performance.now()) {
                if (!this.gameActive || this.gamePaused) return;

                const deltaTime = currentTime - this.lastTime;
                this.lastTime = currentTime;

                this.update(deltaTime);
                this.render();

                requestAnimationFrame((time) => this.gameLoop(time));
            }
        }

        // Initialize game when page loads
        window.addEventListener('load', () => {
            new PokemonSpaceGame();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®å¯æ¢¦å¤ªç©ºå¯¹æˆ˜</title>
    <style>
        /* CSS styles remain unchanged */
        html,
        body {
            margin: 0;
            padding: 0;
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            font-family: Arial, sans-serif;
        }

        #gameCanvas {
            border: 1px solid #333;
            max-width: 100%;
            max-height: 100%;
            display: none;
        }

        #intro-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            text-align: center;
            z-index: 1000;
            cursor: pointer;
        }

        /* Additional CSS styles for buttons and leaderboard */
        /* ... (existing styles) ... */
    </style>
</head>

<body>
    <div id="intro-screen">
        <video id="intro-video" src="videos/pokemon_intro.mp4" preload="metadata"></video>
        <h1>å®å¯æ¢¦å¤ªç©ºå¯¹æˆ˜</h1>
        <p>ç‚¹å‡»æˆ–è§¦æ‘¸å±å¹•å¼€å§‹</p>
    </div>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <div class="game-over" id="gameOverScreen">
        <h1>æ¸¸æˆç»“æŸ</h1>
        <p id="finalScore">æœ€ç»ˆåˆ†æ•°: 0</p>
        <p>æŒ‰ä»»æ„é”®æˆ–ç‚¹å‡»å±å¹•é‡æ–°å¼€å§‹</p>
    </div>

    <!-- Joystick and buttons -->
    <div id="joystick">
        <div id="joystick-handle"></div>
    </div>
    <div id="fire-button">ğŸ”¥</div>
    <div id="pause-button">â¸ï¸</div>

    <!-- Leaderboard -->
    <div id="leaderboard">
        <h2>æ’è¡Œæ¦œ</h2>
        <ol id="leaderboard-list"></ol>
    </div>

    <!-- Multiplayer Button -->
    <div id="show-multiplayer-button">å¤šäººè”æœº</div>

    <!-- Multiplayer Panel -->
    <div id="multiplayer-panel">
        <h2>å¤šäººè”æœºæ¨¡å¼</h2>
        <input type="text" id="player-name" placeholder="è¾“å…¥ä½ çš„æ¸¸æˆåç§°">
        <button id="create-room-btn">åˆ›å»ºæˆ¿é—´</button>
        <button id="join-room-btn">åŠ å…¥æˆ¿é—´</button>
        <input type="text" id="room-id" placeholder="è¾“å…¥æˆ¿é—´ID" style="display:none;">
        <button id="start-game-btn" style="display:none;">å¼€å§‹æ¸¸æˆ</button>
        <div id="player-list">
            <h3>åœ¨çº¿ç©å®¶</h3>
        </div>
        <button id="close-panel-btn">å…³é—­</button>
    </div>

    <script>
        class PokemonSpaceGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gameOverScreen = document.getElementById('gameOverScreen');
                this.finalScoreText = document.getElementById('finalScore');
                this.introScreen = document.getElementById('intro-screen');
                this.introVideo = document.getElementById('intro-video');

                // Leaderboard elements
                this.leaderboardElement = document.getElementById('leaderboard');
                this.leaderboardList = document.getElementById('leaderboard-list');

                // Multiplayer elements
                this.multiplayerPanel = document.getElementById('multiplayer-panel');
                this.playerNameInput = document.getElementById('player-name');
                this.createRoomBtn = document.getElementById('create-room-btn');
                this.joinRoomBtn = document.getElementById('join-room-btn');
                this.roomIdInput = document.getElementById('room-id');
                this.playerList = document.getElementById('player-list');
                this.closePanelBtn = document.getElementById('close-panel-btn');

                // Game state
                this.gameActive = false;
                this.score = 0;
                this.lives = 7;
                this.characterLevel = 1;
                this.maxCharacterLevel = 6;
                this.isMultiplayerMode = false;
                this.clientPlayer = null;
                this.otherPlayers = {};

                // Player properties
                this.playerSize = 80;
                this.playerPos = { x: 160, y: 450 };
                this.bullets = [];
                this.laserActive = false;
                this.laserTimer = 0;

                // Enemy properties
                this.enemies = [];
                this.enemySize = 50;
                this.enemySpeed = 1.2;

                // Leaderboard data
                this.leaderboardData = this.loadLeaderboard();

                // Load images and sounds
                this.loadImages();
                this.loadSounds();

                // Event listeners
                this.introScreen.addEventListener('mousedown', this.handleIntroClick.bind(this));
                this.createRoomBtn.addEventListener('click', this.createRoom.bind(this));
                this.joinRoomBtn.addEventListener('click', this.joinRoom.bind(this));
                this.closePanelBtn.addEventListener('click', this.closeMultiplayerPanel.bind(this));

                this.init();
            }

            // Load images and sounds
            loadImages() {
                this.bgImage = new Image();
                this.bgImage.src = 'images/earth_view.jpg';
                this.playerImage = new Image();
                this.playerImage.src = 'images/rayquaza.png';
                this.enemyImage = new Image();
                this.enemyImage.src = 'images/deoxys.png';
            }

            loadSounds() {
                this.bgMusic = new Audio('sounds/background_music.mp3');
                this.bgMusic.loop = true;
                this.playerShootSound = new Audio('sounds/player_shoot.mp3');
                this.enemyShootSound = new Audio('sounds/enemy_shoot.mp3');
                this.explosionSound = new Audio('sounds/explosion.mp3');
                this.levelUpSound = new Audio('sounds/level_up.mp3');
            }

            // Create client player for multiplayer
            addBasePlayer(name) {
                this.clientPlayer = {
                    "name": name,
                    "width": this.playerSize,
                    "height": this.playerSize,
                    "pos": { x: this.playerPos.x, y: this.playerPos.y }
                };
            }

            showMultiplayerPanel() {
                this.multiplayerPanel.style.display = 'block';
            }

            closeMultiplayerPanel() {
                this.multiplayerPanel.style.display = 'none';
            }

            createRoom() {
                this.playerName = this.playerNameInput.value.trim();
                if (!this.playerName) {
                    alert("è¯·è¾“å…¥ä½ çš„åå­—ã€‚");
                    return;
                }

                this.roomId = this.generateRoomId();
                this.isMultiplayerMode = true;
                this.addBasePlayer(this.playerName);

                alert(`æˆ¿é—´å·²åˆ›å»º! æˆ¿é—´ID: ${this.roomId}. ä¸æœ‹å‹åˆ†äº«ã€‚`);
                this.multiplayerPanel.style.display = 'none';
                this.startGame();
            }

            joinRoom() {
                this.playerName = this.playerNameInput.value.trim();
                if (!this.playerName) {
                    alert("è¯·è¾“å…¥ä½ çš„åå­—ã€‚");
                    return;
                }

                const roomId = this.roomIdInput.value.trim();
                if (!roomId) {
                    alert("è¯·è¾“å…¥è¦åŠ å…¥çš„æˆ¿é—´ID");
                    return;
                }

                this.roomId = roomId;
                this.isMultiplayerMode = true;
                this.addBasePlayer(this.playerName);
                alert(`åŠ å…¥æˆ¿é—´! æˆ¿é—´ID: ${this.roomId}.`);
                this.startGame();
            }

            generateRoomId() {
                return Math.random().toString(36).substring(2, 10).toUpperCase();
            }

            startGame() {
                this.gameActive = true;
                this.init(); // Reset game state
                this.gameLoop();
            }

            // Game loop and other methods remain unchanged
            // ...

            loadLeaderboard() {
                const data = localStorage.getItem('pokemonSpaceGameLeaderboard');
                return data ? JSON.parse(data) : [];
            }

            saveLeaderboard() {
                localStorage.setItem('pokemonSpaceGameLeaderboard', JSON.stringify(this.leaderboardData));
            }

            addScoreToLeaderboard(scoreEntry) {
                this.leaderboardData.push(scoreEntry);
                this.leaderboardData.sort((a, b) => b.score - a.score);
                this.leaderboardData = this.leaderboardData.slice(0, 10);
                this.saveLeaderboard();
                this.updateLeaderboardDisplay();
            }

            updateLeaderboardDisplay() {
                this.leaderboardList.innerHTML = '';
                if (this.leaderboardData.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'æš‚æ— è®°å½•';
                    this.leaderboardList.appendChild(li);
                } else {
                    this.leaderboardData.forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.textContent = `ç¬¬ ${index + 1} å: ${entry.name} - ${entry.score} åˆ†`;
                        this.leaderboardList.appendChild(li);
                    });
                }
            }
        }

        window.onload = function() {
            new PokemonSpaceGame();
        };
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>宝可梦太空对战</title>
    <style>
        /* CSS styles remain unchanged */
        html,
        body {
            margin: 0;
            padding: 0;
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
            font-family: Arial, sans-serif;
        }

        #gameCanvas {
            border: 1px solid #333;
            max-width: 100%;
            max-height: 100%;
            display: none;
        }

        #intro-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            text-align: center;
            z-index: 1000;
            cursor: pointer;
        }

        /* Additional CSS styles for buttons and leaderboard */
        /* ... (existing styles) ... */
    </style>
</head>

<body>
    <div id="intro-screen">
        <video id="intro-video" src="videos/pokemon_intro.mp4" preload="metadata"></video>
        <h1>宝可梦太空对战</h1>
        <p>点击或触摸屏幕开始</p>
    </div>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <div class="game-over" id="gameOverScreen">
        <h1>游戏结束</h1>
        <p id="finalScore">最终分数: 0</p>
        <p>按任意键或点击屏幕重新开始</p>
    </div>

    <!-- Joystick and buttons -->
    <div id="joystick">
        <div id="joystick-handle"></div>
    </div>
    <div id="fire-button">🔥</div>
    <div id="pause-button">⏸️</div>

    <!-- Leaderboard -->
    <div id="leaderboard">
        <h2>排行榜</h2>
        <ol id="leaderboard-list"></ol>
    </div>

    <!-- Multiplayer Button -->
    <div id="show-multiplayer-button">多人联机</div>

    <!-- Multiplayer Panel -->
    <div id="multiplayer-panel">
        <h2>多人联机模式</h2>
        <input type="text" id="player-name" placeholder="输入你的游戏名称">
        <button id="create-room-btn">创建房间</button>
        <button id="join-room-btn">加入房间</button>
        <input type="text" id="room-id" placeholder="输入房间ID" style="display:none;">
        <button id="start-game-btn" style="display:none;">开始游戏</button>
        <div id="player-list">
            <h3>在线玩家</h3>
        </div>
        <button id="close-panel-btn">关闭</button>
    </div>

    <script>
        class PokemonSpaceGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gameOverScreen = document.getElementById('gameOverScreen');
                this.finalScoreText = document.getElementById('finalScore');
                this.introScreen = document.getElementById('intro-screen');
                this.introVideo = document.getElementById('intro-video');

                // Leaderboard elements
                this.leaderboardElement = document.getElementById('leaderboard');
                this.leaderboardList = document.getElementById('leaderboard-list');

                // Multiplayer elements
                this.multiplayerPanel = document.getElementById('multiplayer-panel');
                this.playerNameInput = document.getElementById('player-name');
                this.createRoomBtn = document.getElementById('create-room-btn');
                this.joinRoomBtn = document.getElementById('join-room-btn');
                this.roomIdInput = document.getElementById('room-id');
                this.playerList = document.getElementById('player-list');
                this.closePanelBtn = document.getElementById('close-panel-btn');

                // Game state
                this.gameActive = false;
                this.score = 0;
                this.lives = 7;
                this.characterLevel = 1;
                this.maxCharacterLevel = 6;
                this.isMultiplayerMode = false;
                this.clientPlayer = null;
                this.otherPlayers = {};

                // Player properties
                this.playerSize = 80;
                this.playerPos = { x: 160, y: 450 };
                this.bullets = [];
                this.laserActive = false;
                this.laserTimer = 0;

                // Enemy properties
                this.enemies = [];
                this.enemySize = 50;
                this.enemySpeed = 1.2;

                // Leaderboard data
                this.leaderboardData = this.loadLeaderboard();

                // Load images and sounds
                this.loadImages();
                this.loadSounds();

                // Event listeners
                this.introScreen.addEventListener('mousedown', this.handleIntroClick.bind(this));
                this.createRoomBtn.addEventListener('click', this.createRoom.bind(this));
                this.joinRoomBtn.addEventListener('click', this.joinRoom.bind(this));
                this.closePanelBtn.addEventListener('click', this.closeMultiplayerPanel.bind(this));

                this.init();
            }

            // Load images and sounds
            loadImages() {
                this.bgImage = new Image();
                this.bgImage.src = 'images/earth_view.jpg';
                this.playerImage = new Image();
                this.playerImage.src = 'images/rayquaza.png';
                this.enemyImage = new Image();
                this.enemyImage.src = 'images/deoxys.png';
            }

            loadSounds() {
                this.bgMusic = new Audio('sounds/background_music.mp3');
                this.bgMusic.loop = true;
                this.playerShootSound = new Audio('sounds/player_shoot.mp3');
                this.enemyShootSound = new Audio('sounds/enemy_shoot.mp3');
                this.explosionSound = new Audio('sounds/explosion.mp3');
                this.levelUpSound = new Audio('sounds/level_up.mp3');
            }

            // Create client player for multiplayer
            addBasePlayer(name) {
                this.clientPlayer = {
                    "name": name,
                    "width": this.playerSize,
                    "height": this.playerSize,
                    "pos": { x: this.playerPos.x, y: this.playerPos.y }
                };
            }

            showMultiplayerPanel() {
                this.multiplayerPanel.style.display = 'block';
            }

            closeMultiplayerPanel() {
                this.multiplayerPanel.style.display = 'none';
            }

            createRoom() {
                this.playerName = this.playerNameInput.value.trim();
                if (!this.playerName) {
                    alert("请输入你的名字。");
                    return;
                }

                this.roomId = this.generateRoomId();
                this.isMultiplayerMode = true;
                this.addBasePlayer(this.playerName);

                alert(`房间已创建! 房间ID: ${this.roomId}. 与朋友分享。`);
                this.multiplayerPanel.style.display = 'none';
                this.startGame();
            }

            joinRoom() {
                this.playerName = this.playerNameInput.value.trim();
                if (!this.playerName) {
                    alert("请输入你的名字。");
                    return;
                }

                const roomId = this.roomIdInput.value.trim();
                if (!roomId) {
                    alert("请输入要加入的房间ID");
                    return;
                }

                this.roomId = roomId;
                this.isMultiplayerMode = true;
                this.addBasePlayer(this.playerName);
                alert(`加入房间! 房间ID: ${this.roomId}.`);
                this.startGame();
            }

            generateRoomId() {
                return Math.random().toString(36).substring(2, 10).toUpperCase();
            }

            startGame() {
                this.gameActive = true;
                this.init(); // Reset game state
                this.gameLoop();
            }

            // Game loop and other methods remain unchanged
            // ...

            loadLeaderboard() {
                const data = localStorage.getItem('pokemonSpaceGameLeaderboard');
                return data ? JSON.parse(data) : [];
            }

            saveLeaderboard() {
                localStorage.setItem('pokemonSpaceGameLeaderboard', JSON.stringify(this.leaderboardData));
            }

            addScoreToLeaderboard(scoreEntry) {
                this.leaderboardData.push(scoreEntry);
                this.leaderboardData.sort((a, b) => b.score - a.score);
                this.leaderboardData = this.leaderboardData.slice(0, 10);
                this.saveLeaderboard();
                this.updateLeaderboardDisplay();
            }

            updateLeaderboardDisplay() {
                this.leaderboardList.innerHTML = '';
                if (this.leaderboardData.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = '暂无记录';
                    this.leaderboardList.appendChild(li);
                } else {
                    this.leaderboardData.forEach((entry, index) => {
                        const li = document.createElement('li');
                        li.textContent = `第 ${index + 1} 名: ${entry.name} - ${entry.score} 分`;
                        this.leaderboardList.appendChild(li);
                    });
                }
            }
        }

        window.onload = function() {
            new PokemonSpaceGame();
        };
    </script>
</body>

</html>
